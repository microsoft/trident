# Core build logic that is common to all OneBranch builds.
parameters:
  - name: tridentSourceDirectory
    type: string
    default: "$(Build.SourcesDirectory)"

steps:
  - script: sudo tdnf install -y protobuf protobuf-c openssl-devel clang-devel rust
    displayName: Install native dependencies

  - script: |
      set -eux
      python3 --version
      python3 -m pip install black
      python3 -m black --version
    displayName: Install Python Black

  - script: cargo fmt -- --check 2>&1
    workingDirectory: ${{ parameters.tridentSourceDirectory }}
    displayName: Check Rust Formatting

  - script: |
      set -eux
      python3 -m black -v --check ${{ parameters.tridentSourceDirectory }}
    displayName: Check Python Formatting

  - script: |
      set -ex
      cargo clippy --version
      cargo clippy --locked --all -- -D warnings 2>&1
      cargo clippy --locked --all --all-features -- -D warnings 2>&1
      cargo clippy --locked --all --tests -- -D warnings 2>&1
    workingDirectory: ${{ parameters.tridentSourceDirectory }}
    displayName: Clippy (Linting)

  - script: |
      make validate-api-schema
    workingDirectory: ${{ parameters.tridentSourceDirectory }}
    displayName: Validate Trident API Schema

  - script: cargo check --locked 2>&1
    workingDirectory: ${{ parameters.tridentSourceDirectory }}
    displayName: Check Debug

  - script: cargo check --locked --all-features 2>&1
    workingDirectory: ${{ parameters.tridentSourceDirectory }}
    displayName: Check with all features

  - script: |
      set -eux
      cargo install cargo-nextest --locked
      # Exclude pytest_gen as Mariner Rust is currently failing to build it. See
      # for more details: https://dev.azure.com/mariner-org/ECF/_workitems/edit/6517
      cargo nextest run --workspace --exclude pytest_gen --profile ci
    workingDirectory: ${{ parameters.tridentSourceDirectory }}
    displayName: Test Debug

  - task: PublishTestResults@2
    condition: succeededOrFailed()
    inputs:
      testResultsFormat: "JUnit"
      testResultsFiles: "${{ parameters.tridentSourceDirectory }}/target/nextest/ci/trident_unit_tests.xml"
