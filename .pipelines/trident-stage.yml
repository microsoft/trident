parameters:
- name: tridentRepo
  type: string
  default: self

- name: tridentArtifactSource
  type: string
  default: current # If specific, trident won't build and instead the artifact will be downloaded in other stage.

- name: publishUniversalFeed
  type: boolean
  default: false

- name: codeCoverage
  type: boolean
  default: true

stages:
- stage: Trident
  displayName: Trident RPMs

  jobs:
  - job: TestTrident
    displayName: Check and Unit Test
    condition: eq('${{ parameters.tridentArtifactSource }}', 'current')
    pool:
      type: linux

    variables:
      ob_outputDirectory: '$(Build.SourcesDirectory)/trident/out'

    steps:
    - checkout: ${{ parameters.tridentRepo }}

    - template: test-build.yml
      parameters:
         tridentSourceDirectory: $(Build.SourcesDirectory)/trident

  - job: Coverage
    displayName: Evaluate Unit Test Code Coverage
    condition: and(eq('${{ parameters.tridentArtifactSource }}', 'current'),eq(${{ parameters.codeCoverage }}, true))
    pool:
      type: linux

    variables:
      ob_outputDirectory: '$(Build.SourcesDirectory)/trident/out'

    steps:
    - checkout: ${{ parameters.tridentRepo }}

    - template: coverage.yml
      parameters:
         tridentSourceDirectory: $(Build.SourcesDirectory)/trident
         codeCoverageBaseline: 63 # Unit tests

  - job: BuildTrident
    displayName: Build Release Artifacts
    condition: eq('${{ parameters.tridentArtifactSource }}', 'current')
    pool:
      type: linux

    variables:
      ob_outputDirectory: '$(Build.SourcesDirectory)/trident/out'
      tridentSourceDirectory: $(Build.SourcesDirectory)/trident
      emu_package_name: ''
      emu_package_version: ''

    steps:
    - checkout: ${{ parameters.tridentRepo }}

    - script: |
        set -eux
        emu_package_name=$(grep 'EMU_PACKAGE_NAME ?= [^ ]*' \
                          $(tridentSourceDirectory)/Makefile | \
                          sed 's/EMU_PACKAGE_NAME ?= //')
        echo "##vso[task.setvariable variable=emu_package_name]$emu_package_name"

        emu_package_version=$(grep 'EMU_PACKAGE_VERSION ?= [^ ]*' \
                              $(tridentSourceDirectory)/Makefile | \
                              sed 's/EMU_PACKAGE_VERSION ?= //')
        echo "##vso[task.setvariable variable=emu_package_version]$emu_package_version"
      displayName: 'Extract and Set EMU Package Variables'

    - task: UniversalPackages@0
      displayName: 'Download EMU'
      inputs:
        command: 'download'
        downloadDirectory: '/usr/src/mariner/SOURCES'
        vstsFeed: 'mariner/MarinerCoreArtifacts'
        vstsFeedPackage: '$(emu_package_name)'
        vstsPackageVersion: '$(emu_package_version)'

    - template: release.yml
      parameters:
         tridentSourceDirectory: $(Build.SourcesDirectory)/trident
         publishUniversalFeed: ${{ parameters.publishUniversalFeed }}
