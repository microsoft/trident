parameters:
- name: buildPurpose
  type: string
  default: validation

- name: tridentConfigurationName
  type: string
  default: ''

- name: deploymentEnvironment
  type: string
  default: virtualMachine

- name: hostIp
  type: string
  default: ''

- name: tridentConfigPath
  type: string

- name: tridentSourceDirectory
  type: string

- name: jUnitXMLIdentifier
  type: string
  default: trident_e2e_tests

steps:
- bash: |
    set -eux
    sudo pip3 install pytest
    sudo pip3 install fabric
  workingDirectory: ${{ parameters.tridentSourceDirectory }}
  displayName: "Installing dependencies for E2E tests"

- bash: |
    set -eux
    python3 -u -m pytest \
        -m "${{ parameters.buildPurpose }}" \
        --capture=no \
        --junit-xml=${{ parameters.tridentConfigurationName }}_${{ parameters.jUnitXMLIdentifier }}_$(System.JobAttempt).junit.xml \
        --host ${{ parameters.hostIp }} \
        --configuration ${{ parameters.tridentConfigPath }}
  workingDirectory: ${{ parameters.tridentSourceDirectory }}/e2e_tests
  displayName: "Trident E2E tests"

- task: PublishTestResults@2
  condition: succeededOrFailed()
  inputs:
    testResultsFormat: JUnit
    testResultsFiles: ${{ parameters.tridentSourceDirectory }}/e2e_tests/${{ parameters.tridentConfigurationName }}_${{ parameters.jUnitXMLIdentifier }}_$(System.JobAttempt).junit.xml
    testRunTitle: ${{ parameters.deploymentEnvironment }}_trident_e2e_tests_${{ parameters.tridentConfigurationName }}_$(System.JobAttempt)
  displayName: Publish test results
