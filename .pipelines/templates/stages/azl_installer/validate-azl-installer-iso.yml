parameters:
  - name: isoName
    type: string
    default: azl-installer-unattended

steps:
  # Download azl-installer artifact
  - task: DownloadPipelineArtifact@2
    displayName: "Download azl-installer ISO"
    inputs:
      buildType: current
      artifactName: "azl-installer"
      targetPath: $(Pipeline.Workspace)/azl-installer

  - bash: |
      set -eux

      # Proactively try to fix any possible issue from previous task failure
      sudo dpkg --configure -a

      sudo NEEDRESTART_MODE=a apt-get install -y \
          swtpm \
          swtpm-tools \
          bridge-utils \
          virt-manager \
          qemu-efi \
          qemu-kvm \
          libtpms0 \
          libvirt-daemon-system \
          libvirt-clients \
          python3-libvirt \
          ovmf \
          openssl \
          python3-netifaces \
          python3-docker \
          python3-bcrypt \
          python3-jinja2 \
          zstd

    timeoutInMinutes: 5
    displayName: "Install dependencies"
    retryCountOnTaskFailure: 3

  # Test usb-iso by using serial connection to invoke trident
  - bash: |
      set -eux

      sudo usermod -aG docker $USER
      sudo usermod -a -G libvirt $USER

      mkdir -p ~/.config/libvirt
      cat << EOF > ~/.config/libvirt/libvirt.conf
      uri_default = "qemu:///system"
      EOF
    displayName: "Install dependencies and configure libvirt"
    retryCountOnTaskFailure: 3

  - bash: |
      set -eux
      
      VM_NAME="azl-installer-test-vm"
      sudo virsh shutdown $VM_NAME || true
      while sudo virsh list --all | grep $VM_NAME; do
        sudo virsh list --all | grep $VM_NAME | grep "shut off" && break
        sleep 1
      done

      sudo cp $(Pipeline.Workspace)/azl-installer/${{ parameters.isoName }}.iso /tmp/azl-installer.iso
      sudo qemu-img create -f qcow2 /tmp/$VM_NAME-volume.qcow2 16G

      if ! sudo virsh net-info $VM_NAME-net; then
        sudo virsh net-create $(Build.SourcesDirectory)/.pipelines/templates/stages/azl_installer/azl-installer-net-template.xml
      fi
      if ! sudo virsh list --all | grep $VM_NAME; then
        sudo virsh define $(Build.SourcesDirectory)/.pipelines/templates/stages/azl_installer/azl-installer-vm-template.xml
      fi

      if sudo python3 $(Build.SourcesDirectory)/.pipelines/templates/stages/azl_installer/test-azl-installer-iso.py; then
        echo "AZL installer ISO validation passed."
      else 
        EXIT_CODE=$?
  
        sudo cat /tmp/$VM_NAME-serial0.log

        sudo mkdir -p $(Pipeline.Workspace)/azl-installer-test
        sudo cp /tmp/$VM_NAME-serial0.log $(Pipeline.Workspace)/azl-installer-test/$VM_NAME-serial-$(date +"%Y%m%d_%H%M%S").log
        exit $EXIT_CODE
      fi
    timeoutInMinutes: 10
    displayName: "Test azl-installer ISO (unattended installation)"
    retryCountOnTaskFailure: 3
  
  # Dump serial log of test vm
  - bash: |
      set -eu
      sudo cat /tmp/test.log
      
      sudo mkdir -p $(Pipeline.Workspace)/azl-installer-test
      sudo cp /tmp/test.log $(Pipeline.Workspace)/azl-installer-test/test.log
    timeoutInMinutes: 1
    displayName: "Dump azl-installer serial test log"
    condition: always()
  
  # Capture VHD
  - bash: |
      set -eu

      VM_NAME="azl-installer-test-vm"
      sudo virsh shutdown $VM_NAME || true
      while sudo virsh list --all | grep $VM_NAME; do
        sudo virsh list --all | grep $VM_NAME | grep "shut off" && break
        sleep 1
      done

      sudo mkdir -p $(Pipeline.Workspace)/azl-installer-test
      sudo cp /tmp/$VM_NAME-volume.qcow2 $(Pipeline.Workspace)/azl-installer-test/.

    timeoutInMinutes: 5
    displayName: "Capture azl-installer VHD"
    condition: failed()
