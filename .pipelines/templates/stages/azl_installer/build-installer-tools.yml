parameters:
  - name: buildLiveInstaller
    type: boolean
    default: true

  - name: buildAttendedInstallerSimulator
    type: boolean
    default: true

  - name: buildIsopatch
    type: boolean
    default: true

stages:
  - stage: BuildInstallerTools
    displayName: Build Installer Tools

    jobs:
      - job: BuildInstallerTools
        displayName: Build Installer Tools
        timeoutInMinutes: 60
        pool:
          type: linux
          name: trident-ubuntu-1es-pool-eastus2
          hostArchitecture: amd64

        variables:
          ob_outputDirectory: $(Pipeline.Workspace)/s/trident/installer-tools
          ob_artifactBaseName: installer-tools

        steps:
          - ${{ if eq(variables['Build.Repository.Name'], 'trident')}}:
              - checkout: self
                fetchDepth: 1
                path: s/trident
          - ${{ else }}:
              - checkout: trident
                fetchDepth: 1
                path: s/trident

          - template: ../common_tasks/avoid-pypi-usage.yml

          - ${{ if eq(parameters.buildLiveInstaller, true) }}:
              - bash: |
                  set -eux
                  make bin/liveinstaller
                  mkdir -p $(ob_outputDirectory)
                  mv bin/liveinstaller $(ob_outputDirectory)
                workingDirectory: $(Pipeline.Workspace)/s/trident
                displayName: "Building liveinstaller"

          - ${{ if eq(parameters.buildAttendedInstallerSimulator, true) }}:
              - bash: |
                  set -eux
                  make bin/attendedinstaller-simulator
                  mkdir -p $(ob_outputDirectory)
                  mv bin/attendedinstaller-simulator $(ob_outputDirectory)
                workingDirectory: $(Pipeline.Workspace)/s/trident
                displayName: "Building attendedinstaller-simulator"

          - ${{ if eq(parameters.buildIsopatch, true) }}:
              - bash: |
                  set -eux
                  make bin/isopatch
                  mkdir -p $(ob_outputDirectory)
                  mv bin/isopatch $(ob_outputDirectory)
                workingDirectory: $(Pipeline.Workspace)/s/trident
                displayName: "Building isopatch"
