parameters:
  - name: "stageType"
    displayName: "Pipeline configuration type"
    type: string

stages:
  - stage: DefineTests_E2E
    displayName: Define all E2E test matrices
    dependsOn:
      - BuildingTools
    jobs:
      - job: DefineTests
        displayName: Get List of tests to run
        timeoutInMinutes: 10
        pool:
          type: linux

        variables:
          ob_outputDirectory: $(Build.SourcesDirectory)/build
          ob_artifactBaseName: storm-e2e-select-tests

        steps:
          - task: DownloadPipelineArtifact@2
            displayName: "Download go-tools"
            inputs:
              buildType: current
              artifactName: "go-tools"
              patterns: |
                storm-trident
              targetPath: "$(Build.SourcesDirectory)/bin"
          - bash: |
              chmod +x ./bin/storm-trident
              ./bin/storm-trident script e2e-matrix "${{ parameters.stageType }}"
            name: matrices
            displayName: Matrix of Trident configurations for E2E Tests

  - template: test_execution_template.yml
    parameters:
      hardwareType: "VM"
      runtimeType: "HOST"

  - template: test_execution_template.yml
    parameters:
      hardwareType: "VM"
      runtimeType: "CONTAINER"

  - template: test_execution_template.yml
    parameters:
      hardwareType: "BM"
      runtimeType: "HOST"

  - template: test_execution_template.yml
    parameters:
      hardwareType: "BM"
      runtimeType: "CONTAINER"
