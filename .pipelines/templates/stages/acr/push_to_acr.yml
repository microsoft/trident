parameters:
  - name: "imageName"
    type: string

  - name: "registry"
    displayName: "Container registry to push to"
    type: string
    default: "maritimuspublic"

steps:
  - bash: |
      set -eux
      VERSION="1.2.2"
      curl -LO "https://github.com/oras-project/oras/releases/download/v${VERSION}/oras_${VERSION}_linux_amd64.tar.gz"
      mkdir -p oras-install/
      tar -zxf oras_${VERSION}_*.tar.gz -C oras-install/
      sudo mv oras-install/oras /usr/local/bin/
      rm -rf oras_${VERSION}_*.tar.gz oras-install/
    displayName: "Install ORAS"

  - task: AzureCLI@2
    inputs:
      azureSubscription: maritimus-staging-eastus-cr-service-connection
      scriptType: bash
      scriptLocation: inlineScript
      inlineScript: |
        set -eux

        # Login to ACR
        az acr login -n ${{ parameters.registry }}
    displayName: "Az ACR login"

  - bash: |
      set -eux

      cd "$(ob_outputDirectory)"
      for cosi_file in *.cosi; do
        if [ -f "$cosi_file" ]; then
          filename=$(basename "$cosi_file")
          clone_num=$(echo "$filename" | grep -o '_[0-9]\+' | tr -d '_')
          version_num=$((clone_num + 1))
          version_tag="v$version_num"
          echo "Pushing $filename with tag $version_tag to ${{ parameters.registry }}.azurecr.io"
          oras push ${{ parameters.registry }}.azurecr.io/regular:$version_tag "$cosi_file"
        fi
      done
    displayName: "Push ${{ parameters.imageName }} to registry"
