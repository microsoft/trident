parameters:
  - name: tridentSourceDirectory
    type: string
    default: "."

  - name: tridentConfigPath
    type: string

  - name: runtimeEnv
    displayName: "Runtime environment (host vs container)"
    type: string
    values:
      - host
      - container

steps:
  - bash: |
      set -eux
      sudo snap install yq
    displayName: "Installing dependencies"
    retryCountOnTaskFailure: 3

  - bash: |
      set -eux
      python3 ${{ parameters.tridentSourceDirectory }}/e2e_tests/helpers/edit_host_config.py \
          --keypath ${{ parameters.tridentSourceDirectory }}/e2e_tests/helpers/key \
          --hostconfig ${{ parameters.tridentConfigPath }}/trident-config.yaml \
          --runtimeEnv ${{ parameters.runtimeEnv }}
      chmod 600 ${{ parameters.tridentSourceDirectory }}/e2e_tests/helpers/key
      ssh-keygen -p -m PEM -f ${{ parameters.tridentSourceDirectory }}/e2e_tests/helpers/key -N ""
    workingDirectory: ${{ parameters.tridentSourceDirectory }}
    displayName: "Setting keys to ssh for testing"
