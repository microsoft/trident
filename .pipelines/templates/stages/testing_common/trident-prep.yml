parameters:
  - name: tridentSourceDirectory
    type: string
    default: "."

  - name: tridentConfigPath
    type: string

  - name: runtimeEnv
    displayName: "Runtime environment (host vs container)"
    type: string
    values:
      - host
      - container

  - name: imageName
    displayName: "Image used in the target OS, source of Trident (container vs host)"
    type: string
    default: trident-testimage
    values:
      - trident-testimage
      - trident-container-testimage

  - name: config
    type: string

steps:
  - bash: |
      set -eux
      sudo snap install yq
    displayName: "Installing dependencies"
    retryCountOnTaskFailure: 3

  - bash: |
      set -eux

      cmd=(
        python3 ${{ parameters.tridentSourceDirectory }}/tests/e2e_tests/helpers/edit_host_config.py \
          --keypath ${{ parameters.tridentSourceDirectory }}/tests/e2e_tests/helpers/key \
          --hostconfig ${{ parameters.tridentConfigPath }}/trident-config.yaml \
          --runtimeEnv ${{ parameters.runtimeEnv }}
      )

      if [ "${{ parameters.config }}" == "misc" ]; then
        tag="$(TAG_BASE).1"
        oci_url="oci://$(ACR_NAME).azurecr.io/${{ parameters.imageName }}:${tag}"
        cmd+=(--ociCosiUrl "$oci_url")
      fi

      if [ "${{ parameters.config }}" == "extensions" ]; then
        tag="$(TAG_BASE).1"
        oci_sysext_url="oci://$(ACR_NAME).azurecr.io/$(SYSEXT_REPO):${tag}"
        cmd+=(--ociSysextUrl "$oci_sysext_url")

        # Calculate SHA384 hashes of extension images.
        sysext_sha384=$(sha384sum test-sysext-1.raw | awk '{print $1}')
        cmd+=(--sysextHash "$sysext_sha384")
      fi

      if [ "${{ parameters.config }}" == "root-verity" ]; then
        tag="$(TAG_BASE).1"
        oci_confext_url="oci://$(ACR_NAME).azurecr.io/$(CONFEXT_REPO):${tag}"
        cmd+=(--ociConfextUrl "$oci_confext_url")
        oci_sysext_url="oci://$(ACR_NAME).azurecr.io/$(SYSEXT_REPO):${tag}"
        cmd+=(--ociSysextUrl "$oci_sysext_url")

        # Calculate SHA384 hashes of extension images.
        confext_sha384=$(sha384sum test-confext-1.raw | awk '{print $1}')
        cmd+=(--confextHash "$confext_sha384")
        sysext_sha384=$(sha384sum test-sysext-1.raw | awk '{print $1}')
        cmd+=(--sysextHash "$sysext_sha384")
      fi

      # Execute the command
      "${cmd[@]}"

      # Print out the config
      cat ${{ parameters.tridentConfigPath }}/trident-config.yaml

      chmod 600 ${{ parameters.tridentSourceDirectory }}/tests/e2e_tests/helpers/key
      ssh-keygen -p -m PEM -f ${{ parameters.tridentSourceDirectory }}/tests/e2e_tests/helpers/key -N ""
    workingDirectory: ${{ parameters.tridentSourceDirectory }}
    displayName: "Edit Trident Host Configuration"
