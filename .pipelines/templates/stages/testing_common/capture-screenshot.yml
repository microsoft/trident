parameters:
  - name: deploymentEnvironment
    type: string
    default: virtualMachine
    values:
      - virtualMachine
      - bareMetal

  - name: screenshotName
    type: string

  - name: vmName
    type: string
    default: "virtdeploy-vm-0"

  - name: captureScreenshotIfTrue
    type: string
    default: "true"

  - name: captureScreenshotIfNonNull
    type: string
    default: "notnull"

steps:
  - bash: |
      echo "captureScreenshotIfTrue parameter is set to: ${{ parameters.captureScreenshotIfTrue }}"
      echo "captureScreenshotIfNonNull parameter is set to: ${{ parameters.captureScreenshotIfNonNull }}"
      echo "env vars:"
      printenv
    displayName: "Check env vars"

  - ${{ if eq(parameters.deploymentEnvironment, 'virtualMachine') }}:
    - bash: |
        sudo apt-get install -y imagemagick
      displayName: Install image package
      condition: and(succeededOrFailed(), and(eq(${{ parameters.captureScreenshotIfTrue }}, true), ne(${{ parameters.captureScreenshotIfNonNull }}, 'null')))
      retryCountOnTaskFailure: 3
    - bash: |
        set -eux
        mkdir -p $(ob_outputDirectory)
        # Capture screenshot from the VM using virsh and convert it to PNG format
        sudo virsh screenshot ${{ parameters.vmName }} /tmp/screenshot.ppm
        convert /tmp/screenshot.ppm $(ob_outputDirectory)/${{ parameters.screenshotName }}.png
      condition: and(succeededOrFailed(), and(eq(${{ parameters.captureScreenshotIfTrue }}, true), ne(${{ parameters.captureScreenshotIfNonNull }}, 'null')))
      displayName: "ðŸ“· Capture screenshot: ${{ parameters.screenshotName }}"