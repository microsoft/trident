parameters:
  - name: deploymentEnvironment
    type: string
    default: virtualMachine
    values:
      - virtualMachine
      - bareMetal

  - name: screenshotName
    type: string

  - name: vmName
    type: string
    default: "virtdeploy-vm-0"

  - name: forceRun
    type: boolean
    default: false

steps:
  - ${{ if eq(parameters.deploymentEnvironment, 'virtualMachine') }}:
    - bash: |
        sudo apt-get install -y imagemagick
      displayName: Install image package
      condition: and(succeededOrFailed(), or(${{ parameters.forceRun }}, ne(variables['abActiveVolume'], 'null')))
      retryCountOnTaskFailure: 3
    - bash: |
        set -eux
        mkdir -p $(ob_outputDirectory)
        # Capture screenshot from the VM using virsh and convert it to PNG format
        sudo virsh screenshot ${{ parameters.vmName }} /tmp/screenshot.ppm
        convert /tmp/screenshot.ppm $(ob_outputDirectory)/${{ parameters.screenshotName }}.png
      condition: and(succeededOrFailed(), or(${{ parameters.forceRun }}, ne(variables['abActiveVolume'], 'null')))
      displayName: "ðŸ“· Capture screenshot: ${{ parameters.screenshotName }}"