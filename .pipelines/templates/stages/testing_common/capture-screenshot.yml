parameters:
  - name: deploymentEnvironment
    type: string
    default: virtualMachine
    values:
      - virtualMachine
      - bareMetal

  - name: screenshotName
    type: string

  - name: vmName
    type: string
    default: "virtdeploy-vm-0"

  - name: captureScreenshot
    type: boolean
    default: true

steps:
  - ${{ if eq(parameters.deploymentEnvironment, 'bareMetal') }}:
    - bash: |
        set -eux
        mkdir -p $(ob_outputDirectory)
        ./bin/netlaunch \
            --config $(TRIDENT_SOURCE_DIR)/baremetal-netlaunch.yaml \
            --force-color \
            --port ${{ variables.NETLAUNCH_PORT }} \
            --screenshot-path /tmp/screenshot
        ORIG_SCREENSHOT_FILE=$(find /tmp/screenshot/screenshot.* | head -n 1)
        ORIG_SCREENSHOT_EXT="${ORIG_SCREENSHOT_FILE##*.}"
        mv "$ORIG_SCREENSHOT_FILE" "$(ob_outputDirectory)/${{ parameters.screenshotName }}.$ORIG_SCREENSHOT_EXT"
      condition: and(succeededOrFailed(), eq(${{ parameters.captureScreenshot }}, true))
      displayName: "ðŸ“· Capture screenshot: ${{ parameters.screenshotName }}"

  - ${{ if eq(parameters.deploymentEnvironment, 'virtualMachine') }}:
    - bash: |
        sudo apt-get install -y imagemagick
      displayName: Install image package
      retryCountOnTaskFailure: 3

    - bash: |
        set -eux
        mkdir -p $(ob_outputDirectory)
        # Capture screenshot from the VM using virsh and convert it to PNG format
        sudo virsh screenshot ${{ parameters.vmName }} /tmp/screenshot.ppm
        convert /tmp/screenshot.ppm $(ob_outputDirectory)/${{ parameters.screenshotName }}.png
      condition: and(succeededOrFailed(), eq(${{ parameters.captureScreenshot }}, true))
      displayName: "ðŸ“· Capture screenshot: ${{ parameters.screenshotName }}"
