parameters:
  - name: netlistenConfigFile
    type: string

  - name: outputDirectory
    type: string

  - name: partition
    type: string

  - name: displayNameSuffix
    type: string
    default: ""

  - name: artifactPrefix
    type: string
    default: "stage-finalize-ab-update-target-os"

steps:
  - bash: |
      set -eux

      export SERIAL_LOG=""
      if [[  -n "${{ parameters.netlistenConfigFile }}" && -f "${{ parameters.netlistenConfigFile }}" ]]; then
        export SERIAL_LOG=$(sudo yq -e '.netlisten.bmc.serialOverSsh.output' ${{ parameters.netlistenConfigFile }})
        echo "Using serial log from netlisten config file (${{ parameters.netlistenConfigFile }}): $SERIAL_LOG"
      fi
      if [[ "$SERIAL_LOG" == "" ]]; then
        echo "Netlisten config file does not contain 'bmc' keyword, retrieve serial output from local VM"
        export SERIAL_LOG="$(find /tmp/*-serial0.log | head -n 1)"
      fi

      # Output the serial log
      SERIAL_LOG_ARTIFACT_PATH="${{ parameters.outputDirectory }}/${{ parameters.artifactPrefix }}-${{ parameters.partition }}-serial.log"
      if [ -f $SERIAL_LOG ]; then
        sudo cp $SERIAL_LOG $SERIAL_LOG_ARTIFACT_PATH
        sudo chmod 644 $SERIAL_LOG_ARTIFACT_PATH
        echo "Serial log found:"
        sudo cat $SERIAL_LOG
      else
        echo "Serial log not found!"
        echo "(No serial log captured)" > $SERIAL_LOG_ARTIFACT_PATH
      fi
    displayName: "ðŸ“„ Display serial output from update to ${{ parameters.partition }} ${{ parameters.displayNameSuffix }}"
    condition: and(succeededOrFailed(), ne(variables['abActiveVolume'], 'null'))
