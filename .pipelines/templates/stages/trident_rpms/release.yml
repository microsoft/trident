steps:
  - script: |
      set -eux
      TRIDENT_VERSION=$(python3 ./scripts/get-version.py "$(Build.BuildNumber)" --commit)
      echo "##vso[task.setvariable variable=trident_version]$TRIDENT_VERSION"
    displayName: "Setting trident version"

  - task: onebranch.pipeline.version@1
    displayName: "Set build number"
    inputs:
      system: "Custom"
      customVersion: $(trident_version)

  - task: CopyFiles@2
    inputs:
      sourceFolder: "./artifacts"
      targetFolder: "/usr/src/mariner/SOURCES"
      contents: "*"
    displayName: Copy EMU to SOURCES

  - script: sudo tdnf install -y protobuf protobuf-c openssl-devel clang-devel rust p7zip p7zip-plugins zstd
    displayName: Install native dependencies
    retryCountOnTaskFailure: 3

  - script: |
      set -eux
      full_version=$(trident_version)

      # Separate into version and prerelease identifier
      # for the RPM build.
      version=$(echo $full_version | cut -d'-' -f1)
      prerelease=$(echo $full_version | cut -d'-' -f2-)

      rpmbuild -bb --build-in-place trident.spec \
        --define="trident_version $full_version" \
        --define="rpm_ver $version" \
        --define="rpm_rel $prerelease"
    displayName: Build RPM

  - task: CopyFiles@2
    inputs:
      sourceFolder: "/usr/src/mariner/RPMS/x86_64"
      targetFolder: "$(ob_outputDirectory)"
    displayName: Copy RPM file to output

  - script: ./scripts/extract-binary.sh /usr/src/mariner/RPMS/x86_64 $(ob_outputDirectory)
    displayName: Extract Trident binary

  - template: common/setup-registries-template.yaml@platform-pipelines

  - script: |
      set -eux

      # Download newer systemd RPMs (needed until we switch to AZL3)
      make artifacts/systemd/systemd-254-3.cm2.x86_64.rpm

      mkdir -p bin
      cp -r /usr/src/mariner/RPMS bin/

      # Explicitly check for Docker Buildx and install if not available
      if [ ! -f ~/.docker/cli-plugins/docker-buildx ]; then
          echo "Docker Buildx not found. Installing..."

          # Determine system architecture for downloading the correct Buildx binary
          ARCH=$(uname -m)
          case "$ARCH" in
              x86_64) ARCH="amd64";;
              aarch64) ARCH="arm64";;
              arm*) ARCH="arm-v7";;
              *) echo "Unsupported architecture: $ARCH"; exit 1;;
          esac

          # Set the desired version of Buildx
          BUILDX_VERSION="v0.8.2"

          # Compose Buildx binary path
          BUILDX_BIN_PATH="https://github.com/docker/buildx/releases/download/${BUILDX_VERSION}/buildx-${BUILDX_VERSION}.linux-${ARCH}"

          # Download and install Buildx
          mkdir -p ~/.docker/cli-plugins
          curl -sSL $BUILDX_BIN_PATH -o ~/.docker/cli-plugins/docker-buildx
          chmod a+x ~/.docker/cli-plugins/docker-buildx
          echo "Docker Buildx installed."
          echo "Docker Buildx version:"
          ~/.docker/cli-plugins/docker-buildx version
      else
          echo "Docker Buildx is already installed."
      fi

      DOCKER_BUILDKIT=1 docker build -f Dockerfile.runtime --progress plain -t trident/trident:latest .

      # ado redacts random strings (like `ecfafoncpriv`). To still be able
      # to show some useful logs, we replace some parts so that ado does not
      # exclude them.
      #
      echo "container_registry_rw_user    :" $(container_registry_rw_user)
      echo "container_registry_pub        :" $(echo $(container_registry_pub) | sed 's/afo/___/g')

      docker login "$(container_registry_pub)" -u "$(container_registry_rw_user)" -p "$(container_registry_rw_pswd)"
      TAG="$(container_registry_pub)"/trident:$(Build.BuildNumber)
      docker tag trident/trident:latest $TAG
      docker push $TAG
    displayName: Build and publish Docker image
    retryCountOnTaskFailure: 3
