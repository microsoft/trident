parameters:
  - name: tridentArtifactName
    type: string

  - name: "stageType"
    displayName: "Controls whether this is a pre-release or a release run."
    type: string
    values:
      - pre
      - rel

  - name: specificVersion
    type: string
    displayName: |
      Specific version of the package to download, leave empty to download latest.
    default: ""

stages:
  - stage: Trident
    displayName: Trident RPMs (Download)

    jobs:
      - job: DownloadTrident
        displayName: Download Trident
        pool:
          type: linux

        variables:
          # Control the name of the artifact where trident binaries are stored
          - name: ob_artifactBaseName
            value: ${{ parameters.tridentArtifactName }}
          - name: ob_outputDirectory
            value: "$(Build.SourcesDirectory)/out"

          - template: ../../feed-staging-vars.yml

          # Set the download artifact suffix to be that of the *previous* stage
          - name: downloadArtifactSuffix
            ${{ if eq(parameters.stageType, 'pre') }}:
              value: ${{ variables.stage_ci_suffix }}
            ${{ if eq(parameters.stageType, 'rel') }}:
              value: ${{ variables.stage_pre_suffix }}

        steps:
          - script: sudo tdnf install -y p7zip p7zip-plugins zstd
            displayName: Install native dependencies to extract trident binary
            retryCountOnTaskFailure: 3

          - template: ../common_tasks/download-universal-artifact.yml
            parameters:
              packageName: ${{ variables.rpmsPackageBaseName }}${{ variables.downloadArtifactSuffix }}
              downloadLocation: $(ob_outputDirectory)
              outputVersionVariable: trident_version
              specificVersion: ${{ parameters.specificVersion }}

          - script: ./scripts/extract-binary.sh $(ob_outputDirectory) $(ob_outputDirectory)
            displayName: Extract Trident binary

          - task: onebranch.pipeline.version@1
            displayName: "Set build number"
            inputs:
              system: "Custom"
              customVersion: $(trident_version)
