parameters:
  - name: tridentArtifactName
    type: string

  - name: codeCoverage
    type: boolean
    default: true

stages:
  - stage: Trident
    displayName: Trident RPMs (Build)

    jobs:
      - job: CheckTrident
        displayName: Check
        pool:
          type: linux

        variables:
          - name: ob_outputDirectory
            value: "$(Build.SourcesDirectory)/trident/out"

        steps:
          - template: check.yml

      - job: TestTrident
        displayName: Unit Test
        pool:
          type: linux

        variables:
          - name: ob_outputDirectory
            value: "$(Build.SourcesDirectory)/trident/out"

        steps:
          - template: ../common_tasks/cargo-auth.yml
            parameters:
              action: override
          - template: unit-test.yml

      - job: Coverage
        displayName: Evaluate Unit Test Code Coverage
        condition: eq(${{ parameters.codeCoverage }}, true)
        pool:
          type: linux

        variables:
          ob_outputDirectory: "$(Build.SourcesDirectory)/trident/out"

        steps:
          - template: ../common_tasks/cargo-auth.yml
            parameters:
              action: override
          - template: ../common_tasks/coverage.yml
            parameters:
              codeCoverageBaseline: 70 # Unit tests

      - job: BuildTrident
        displayName: Build Trident 3.0 RPMs
        pool:
          type: linux

        variables:
          - name: ob_artifactBaseName
            value: ${{ parameters.tridentArtifactName }}
          - name: ob_outputDirectory
            value: "$(Build.SourcesDirectory)/out"
          - template: common/setup-registries-vars-template.yaml@platform-pipelines
            parameters:
              buildType: auto

        steps:
          - template: ../common_tasks/cargo-auth.yml
          - template: ../common_tasks/download-emu.yml
          - template: release.yml

      - job: BuildTrident2
        displayName: Build Trident 2.0 RPMs
        pool:
          type: linux

        variables:
          - name: ob_artifactBaseName
            value: ${{ parameters.tridentArtifactName }}2
          - name: ob_outputDirectory
            value: "$(Build.SourcesDirectory)/out"
          - template: common/setup-registries-vars-template.yaml@platform-pipelines
            parameters:
              buildType: auto

        steps:
          - template: ../common_tasks/cargo-auth.yml
            parameters:
              action: override
          - template: ../common_tasks/download-emu.yml
          - template: release2.yml

      # Build trident RPMs for dom0.  The dom0 image requires
      # systemd version 250.  This allows trident-service to
      # be deployed and phonehome, but using systemd 250 leads
      # to an issue with a partitioning feature.  When dom0 is
      # migrated to azl3, this needs to be removed.
      - job: BuildTrident2forDom0
        displayName: Build Trident 2.0 RPMs for dom0
        pool:
          type: linux

        variables:
          - name: ob_artifactBaseName
            value: ${{ parameters.tridentArtifactName }}2-dom0
          - name: ob_outputDirectory
            value: "$(Build.SourcesDirectory)/out"
          - template: common/setup-registries-vars-template.yaml@platform-pipelines
            parameters:
              buildType: auto

        steps:
          - template: ../common_tasks/cargo-auth.yml
            parameters:
              action: override
          - template: ../common_tasks/download-emu.yml
          - template: release2.yml
            parameters:
              minimumSystemdVersion: 250
