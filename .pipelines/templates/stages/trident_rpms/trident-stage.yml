parameters:
  - name: "stageType"
    displayName: "Pipeline configuration type"
    type: string
    values:
      - pr
      - pr-e2e
      - pr-e2e-azure
      - ci
      - pre
      - rel
      - full-validation

  - name: codeCoverage
    type: boolean
    default: true

  - name: tridentArtifactName
    type: string

  - name: baseimgBuildType
    displayName: Base Image build type
    type: string
    values:
      - dev
      - preview
      - release
    default: "release"

  - name: baseImagePipelineBuildId
    type: string
    default: "latestFromBranch"

  - name: baseImageArm64PipelineBuildId
    type: string
    default: "latestFromBranch"

  - name: forceTridentRebuild
    type: boolean
    default: false

  - name: osModifierBranch
    type: string
    default: "submodule"

stages:
  - ${{ if or(parameters.forceTridentRebuild, eq(parameters.stageType, 'pr'), eq(parameters.stageType, 'pr-e2e'), eq(parameters.stageType, 'ci'), eq(parameters.stageType, 'pr-e2e-azure')) }}:
      - template: build-source.yml
        parameters:
          ${{ if eq(parameters.stageType, 'pr') }}:
            publishToDevFeed: true
          tridentArtifactName: ${{ parameters.tridentArtifactName }}
          codeCoverage: ${{ parameters.codeCoverage }}
          baseimgBuildType: ${{ parameters.baseimgBuildType }}
          baseImagePipelineBuildId: ${{ parameters.baseImagePipelineBuildId }}
          baseImageArm64PipelineBuildId: ${{ parameters.baseImageArm64PipelineBuildId }}
          osModifierBranch: ${{ parameters.osModifierBranch }}

  - ${{ else }}:
      - template: ../download_staged/download-staged.yml
        parameters:
          artifactName: ${{ parameters.tridentArtifactName }}
          stageType: ${{ parameters.stageType }}
          packageName: rpms
