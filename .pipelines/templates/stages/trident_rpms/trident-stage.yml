parameters:
  - name: "stageType"
    displayName: "Controls whether this is a pre-release or a CI run."
    type: string
    values:
      - pr
      - pr-e2e
      - ci
      - pre
      - rel

  - name: codeCoverage
    type: boolean
    default: true

  - name: tridentArtifactName
    type: string

  - name: baseimgBuildType
    displayName: Base Image build type
    type: string
    values:
      - preview
      - release
    default: "release"

  - name: previewContainerImageBuildId
    type: string
    default: "latestFromBranch"

  - name: forceTridentRebuild
    type: boolean
    default: false

stages:
  - ${{ if or(parameters.forceTridentRebuild, eq(parameters.stageType, 'pr'), eq(parameters.stageType, 'pr-e2e'), eq(parameters.stageType, 'ci')) }}:
      - template: build-source.yml
        parameters:
          tridentArtifactName: ${{ parameters.tridentArtifactName }}
          codeCoverage: ${{ parameters.codeCoverage }}
          baseimgBuildType: ${{ parameters.baseimgBuildType }}
          previewContainerImageBuildId: ${{ parameters.previewContainerImageBuildId }}

  - ${{ else }}:
      - template: ../download_staged/download-staged.yml
        parameters:
          artifactName: ${{ parameters.tridentArtifactName }}
          stageType: ${{ parameters.stageType }}
          feedName: rpms
