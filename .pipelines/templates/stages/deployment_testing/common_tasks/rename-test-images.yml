parameters:
  - name: targetDirectory
    type: string
    default: artifacts/test-image

  - name: testImageDir
    type: string
    default: ""

  - name: verityTestImageDir
    type: string
    default: ""

steps:
  - bash: |
      set -eux
      mkdir -p artifacts/test-image

      # If testImageDir is not an empty string, rename the Trident test images
      if [ -n "${{ parameters.testImageDir }}" ]; then
        mv ${{ parameters.testImageDir }}/esp.raw.zst ${{ parameters.targetDirectory }}/esp.rawzst
        mv ${{ parameters.testImageDir }}/root.raw.zst ${{ parameters.targetDirectory }}/root.rawzst
      fi

      # If verityTestImageDir is not an empty string, rename the Trident verity test images
      if [ -n "${{ parameters.verityTestImageDir }}" ]; then
        # Verity image for functional testing and e2e testing
        mv ${{ parameters.verityTestImageDir }}/esp.raw.zst ${{ parameters.targetDirectory }}/verity_esp.rawzst
        mv ${{ parameters.verityTestImageDir }}/boot.raw.zst ${{ parameters.targetDirectory }}/verity_boot.rawzst
        mv ${{ parameters.verityTestImageDir }}/root.raw.zst ${{ parameters.targetDirectory }}/verity_root.rawzst
        mv ${{ parameters.verityTestImageDir }}/root-hash.raw.zst ${{ parameters.targetDirectory }}/verity_roothash.rawzst
        mv ${{ parameters.verityTestImageDir }}/var.raw.zst ${{ parameters.targetDirectory }}/verity_var.rawzst
      fi
    displayName: "Rename Trident test images for A/B update testing"
