parameters:
  - name: tridentSourceDirectory
    type: string
    default: "."

  - name: tridentConfigPath
    type: string

  - name: deploymentEnvironment
    type: string

  - name: tridentConfigurationName
    type: string

  - name: metricsFile
    type: string

  - name: kustoDatabaseName
    type: string
    default: "trident"

  - name: kustoTableName
    type: string

  - name: kustoTableMapping
    type: string
    default: "trident_mapping"

  - name: runOnFailure
    type: boolean
    default: false

steps:
  - bash: |
      set -eux
      python3 ${{ parameters.tridentSourceDirectory }}/e2e_tests/helpers/process_trident_metrics.py --trident-config ${{ parameters.tridentConfigPath }}/trident-config.yaml --metrics-file ${{ parameters.metricsFile }}
    workingDirectory: ${{ parameters.tridentSourceDirectory }}
    displayName: "Process Trident metrics"
    condition: or(succeeded(), and(succeededOrFailed(), eq('${{ parameters.runOnFailure }}', true)))
    env:
      TRIDENT_CONFIGURATION_NAME: ${{ parameters.tridentConfigurationName }}
      SOURCE_BRANCH_NAME: $(Build.SourceBranchName)
      MACHINE_TYPE: ${{ parameters.deploymentEnvironment }}
      PIPELINE_NAME: $(Build.DefinitionName)

  - template: pipelines/templates/upload-metrics-step.yaml@platform-telemetry
    parameters:
      kustoDatabaseName: ${{ parameters.kustoDatabaseName }}
      kustoTableName: ${{ parameters.kustoTableName }}
      kustoTableMapping: ${{ parameters.kustoTableMapping }}
      metricsFile: ${{ parameters.metricsFile }}
      runOnFailure: ${{ parameters.runOnFailure }}
