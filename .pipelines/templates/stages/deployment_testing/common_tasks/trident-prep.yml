parameters:
  - name: tridentSourceDirectory
    type: string
    default: "."

  - name: updateRuntimeOSTrident
    type: boolean
    default: false

  - name: tridentConfigPath
    type: string

steps:
  - bash: |
      set -eux
      sudo snap install yq
    displayName: "Installing dependencies"

  - bash: |
      set -eux
      sudo yq eval '.host-configuration.trident.self-upgrade = true' trident-config.yaml -i
    condition: eq(${{ parameters.updateRuntimeOSTrident }}, true)
    workingDirectory: ${{ parameters.tridentConfigPath }}
    displayName: "Update trident in Runtime OS"

  - bash: |
      set -eux
      python3 ${{ parameters.tridentSourceDirectory }}/e2e_tests/helpers/add_key.py \
          --keypath ${{ parameters.tridentSourceDirectory }}/e2e_tests/helpers/key \
          --tridentconfig ${{ parameters.tridentConfigPath }}/trident-config.yaml
      openssl rsa -in ${{ parameters.tridentSourceDirectory }}/e2e_tests/helpers/key \
          -out ${{ parameters.tridentSourceDirectory }}/e2e_tests/helpers/key -traditional
      chmod 600 ${{ parameters.tridentSourceDirectory }}/e2e_tests/helpers/key
    workingDirectory: ${{ parameters.tridentSourceDirectory }}
    displayName: "Setting keys to ssh for testing"
