parameters:
  - name: buildPurpose
    type: string
    default: validation

  - name: tridentConfigurationName
    type: string
    default: ""

  - name: deploymentEnvironment
    type: string
    default: virtualMachine

  - name: hostIp
    type: string
    default: ""

  - name: tridentConfigPath
    type: string

  - name: jUnitXMLIdentifier
    type: string
    default: trident_e2e_tests

steps:
  - bash: |
      set -eux
      sudo pip3 install pytest
      sudo pip3 install fabric
    displayName: "Installing dependencies for E2E tests"

  - bash: |
      set -eux
      sshKeyPath="$(Build.SourcesDirectory)/e2e_tests/helpers/key"
      ls -l "$sshKeyPath"
      # Check SSH connection and wait for 2 minutes if it fails
      for i in {1..24}; do
        if ssh -q -o "StrictHostKeyChecking=no" -i "$sshKeyPath" testing-user@${{ parameters.hostIp }} exit; then
          echo "SSH connection successful. VM is up and running."
            break
        else
            echo "SSH connection failed. Waiting for 5 seconds before retrying..."
            sleep 5
        fi
      done
    displayName: "Check SSH connection"

  - bash: |
      set -eux
      python3 -u -m pytest \
          -m "${{ parameters.buildPurpose }}" \
          --capture=no \
          --junit-xml=${{ parameters.tridentConfigurationName }}_${{ parameters.jUnitXMLIdentifier }}_$(System.JobAttempt).junit.xml \
          --host ${{ parameters.hostIp }} \
          --configuration ${{ parameters.tridentConfigPath }}
    workingDirectory: ./e2e_tests
    displayName: "Trident E2E tests"

  - task: PublishTestResults@2
    condition: succeededOrFailed()
    inputs:
      testResultsFormat: JUnit
      testResultsFiles: ./e2e_tests/${{ parameters.tridentConfigurationName }}_${{ parameters.jUnitXMLIdentifier }}_$(System.JobAttempt).junit.xml
      testRunTitle: ${{ parameters.deploymentEnvironment }}_trident_e2e_tests_${{ parameters.tridentConfigurationName }}_$(System.JobAttempt)
    displayName: Publish test results
