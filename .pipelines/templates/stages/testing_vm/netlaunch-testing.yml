parameters:
  - name: buildPurpose
    type: string
    default: "post_merge"
    values:
      - daily
      - pullrequest
      - post_merge
      - validation

  - name: testingRun
    displayName: "Pipeline run downloaded Trident images"
    type: boolean
    default: false

  - name: runtimeEnv
    displayName: "Runtime environment (host vs container)"
    type: string
    default: "host"
    values:
      - host
      - container

stages:
  - stage: DeploymentTesting_${{ parameters.runtimeEnv }}
    displayName: Deployment VM ${{ parameters.runtimeEnv }} Testing
    dependsOn:
      - ${{ if eq(parameters.testingRun, true) }}:
          - DownloadTestingElements
      - ${{ else }}:
          - BuildingTools
          - TridentTestImg_trident_verity_testimage
          - ${{ if eq(parameters.runtimeEnv, 'container') }}:
              - TridentTestImg_trident_container_installer_testimage
              - TridentTestImg_trident_container_testimage
          - ${{ else }}:
              - TridentTestImg_trident_installer_testimage
              - TridentTestImg_trident_testimage

    jobs:
      - template: ../testing_common/get-tests.yml
        parameters:
          buildPurpose: ${{ parameters.buildPurpose }}
          deploymentEnvironment: virtualMachine
          runtimeEnv: ${{ parameters.runtimeEnv }}

      - job: Testing
        dependsOn: DefineTests
        timeoutInMinutes: 30
        continueOnError: ${{ eq(parameters.runtimeEnv, 'container') }}
        pool:
          type: linux
          name: trident-ubuntu-1es-pool-eastus2
          hostArchitecture: amd64

        strategy:
          matrix: $[ dependencies.DefineTests.outputs['setConfigurations.matrixConfigurations'] ]

        variables:
          tridentConfigurationName: $(configuration)
          tridentConfigPath: $(tridentSourceDirectory)/e2e_tests/trident_configurations/$(tridentConfigurationName)

          tridentSourceDirectory: $(Build.SourcesDirectory)
          argusToolkitSourceDirectory: $(Build.SourcesDirectory)/argus-toolkit

          ${{ if eq(parameters.runtimeEnv, 'container') }}:
            installerISO: trident-container-installer-testimage.iso
          ${{ else }}:
            installerISO: trident-installer-testimage.iso

          ob_outputDirectory: $(tridentSourceDirectory)/deployment_logs
          ob_artifactBaseName: $(tridentConfigurationName)_${{ parameters.runtimeEnv }}_deployment_log_$(System.JobAttempt)

          netlaunchPort: 4000

        steps:
          - checkout: argus-toolkit
            fetchDepth: 1

          - template: netlaunch-prep.yml
            parameters:
              ${{ if eq(parameters.runtimeEnv, 'container') }}:
                installerISO: trident-container-installer-testimage
                tridentTestImage: trident-container-testimage
              ${{ else }}:
                installerISO: trident-installer-testimage
                tridentTestImage: trident-testimage

          - template: ../testing_common/trident-prep.yml
            parameters:
              tridentSourceDirectory: $(tridentSourceDirectory)
              tridentConfigPath: $(tridentConfigPath)
              runtimeEnv: ${{ parameters.runtimeEnv }}

          - bash: |
              set -eux
              sg libvirt "./virt-deploy create --mem 12 --disks 32,32"
              sg libvirt "./virt-deploy run"
            workingDirectory: $(argusToolkitSourceDirectory)
            displayName: "Running sushy tools for testing deployment with BMC"

          - bash: |
              set -eux
              mv $(System.ArtifactsDirectory)/container/trident-container.tar.gz $(tridentSourceDirectory)/artifacts/test-image/
              ls -la $(tridentSourceDirectory)/artifacts/test-image/
            condition: and(succeeded(), eq('${{ parameters.runtimeEnv }}', 'container'))
            displayName: "Move container image to the serveFolder for netlaunch"

          - bash: |
              set -euxo pipefail
              MAX_FAILURES_FLAG=""

              # rerun is expected to fail ONCE
              if [ ${{ variables['tridentConfigurationName'] }} == 'rerun' ]; then 
                MAX_FAILURES_FLAG="--max-failures 1"
              fi

              # memory-constraint-combined is meant to produce ONE failure
              # because the first run modifies the service file and exits
              # prematurely, so that the second run will have the memory
              # constraints applied.
              if [ ${{ variables['tridentConfigurationName'] }} == 'memory-constraint-combined' ]; then 
                MAX_FAILURES_FLAG="--max-failures 1"
              fi

              ./bin/netlaunch \
                  --iso $(System.ArtifactsDirectory)/$(installerISO) \
                  --config $(argusToolkitSourceDirectory)/vm-netlaunch.yaml \
                  --trident $(tridentConfigPath)/trident-config.yaml \
                  --servefolder ./artifacts/test-image \
                  --logstream $MAX_FAILURES_FLAG \
                  --trace-file trident-metrics.jsonl \
                  --force-color \
                  --full-logstream logstream-full.log \
                  --port ${{variables.netlaunchPort}} 2>&1 | tee ./clean-install-deployment.log
            timeoutInMinutes: 13
            workingDirectory: $(tridentSourceDirectory)
            displayName: "Run netlaunch for testing"

          - template: ../testing_common/display-deployment-logs.yml
            parameters:
              deploymentLogPath: $(tridentSourceDirectory)/logstream-full.log
              displayName: "Display clean install logs"

          - bash: |
              set -ux

              VM_NAME=$(jq -r '.virtualmachines[0].name' $(argusToolkitSourceDirectory)/virt-deploy-metadata.json)
              VM_SERIAL_LOG="/tmp/$VM_NAME-serial0.log"

              until [ -f "$VM_SERIAL_LOG" ]
              do
                  sleep 0.1
              done

              echo "Found VM serial log file: $VM_SERIAL_LOG"
              echo "VM serial log:"

              sudo $(tridentSourceDirectory)/e2e_tests/helpers/wait_for_login.py \
                  -d "$VM_SERIAL_LOG" \
                  -o ./serial.log \
                  -t 250

              WAIT_FOR_LOGIN_EXITCODE=$?

              mkdir -p $(ob_outputDirectory)
              sudo cp ./serial.log $(ob_outputDirectory)/serial.log

              exit $WAIT_FOR_LOGIN_EXITCODE

            timeoutInMinutes: 5
            condition: succeededOrFailed()
            displayName: "Check Runtime OS deployment"

          - bash: |
              set -eux
              HOST_IP=$(jq -r '.virtualmachines[0].ip' $(argusToolkitSourceDirectory)/virt-deploy-metadata.json)
              ssh -o StrictHostKeyChecking=no -i $(tridentSourceDirectory)/e2e_tests/helpers/key testing-user@$HOST_IP \
                'sudo journalctl -u docker.service'
              ssh -o StrictHostKeyChecking=no -i $(tridentSourceDirectory)/e2e_tests/helpers/key testing-user@$HOST_IP \
                'sudo journalctl -u trident-container.service'
            condition: eq('${{ parameters.runtimeEnv }}', 'container')
            displayName: "Display Container logs"

          - template: ../testing_common/trident-metrics.yml
            parameters:
              tridentSourceDirectory: $(tridentSourceDirectory)
              tridentConfigPath: $(tridentConfigPath)
              deploymentEnvironment: virtualMachine
              runtimeEnvironment: ${{ parameters.runtimeEnv }}
              tridentConfigurationName: $(tridentConfigurationName)
              metricsFile: $(tridentSourceDirectory)/trident-metrics.jsonl
              ${{ if eq(variables['Build.SourceBranchName'], 'main') }}:
                kustoTableName: main
              ${{ if ne(variables['Build.SourceBranchName'], 'main') }}:
                kustoTableName: dev

          - template: ../testing_common/e2e-test-run.yml
            parameters:
              buildPurpose: ${{ parameters.buildPurpose }}
              deploymentEnvironment: virtualMachine
              tridentConfigurationName: $(tridentConfigurationName)
              hostIp: $(jq -r '.virtualmachines[0].ip' $(argusToolkitSourceDirectory)/virt-deploy-metadata.json)
              runtimeEnv: ${{ parameters.runtimeEnv }}
              tridentConfigPath: $(tridentConfigPath)
              sshKeyPath: $(tridentSourceDirectory)/e2e_tests/helpers/key
              userName: testing-user
              artifactsDirectory: artifacts/test-image
              netlistenPort: ${{variables.netlaunchPort}}

          - template: ../testing_common/trident-rebuild.yml
            parameters:
              hostIp: $(jq -r '.virtualmachines[0].ip' $(argusToolkitSourceDirectory)/virt-deploy-metadata.json)
              sshKeyPath: $(tridentSourceDirectory)/e2e_tests/helpers/key
              userName: testing-user
              runtimeEnv: ${{ parameters.runtimeEnv }}
              tridentSourceDirectory: $(tridentSourceDirectory)
              tridentConfigPath: $(tridentConfigPath)

          - bash: |
              set -eux
              sudo virsh shutdown virtdeploy-vm-0
              mkdir -p $(ob_outputDirectory)
              sudo cp /var/lib/libvirt/images/virtdeploy-pool/virtdeploy-vm-0-0-volume.qcow2 $(ob_outputDirectory)/
              sudo zstd -T0 $(ob_outputDirectory)/virtdeploy-vm-0-0-volume.qcow2
              sudo cp $(tridentSourceDirectory)/e2e_tests/helpers/key $(ob_outputDirectory)
              sudo chmod 777 $(ob_outputDirectory)/key
            workingDirectory: $(tridentSourceDirectory)
            condition: failed()
            displayName: "Publish OS disk"
