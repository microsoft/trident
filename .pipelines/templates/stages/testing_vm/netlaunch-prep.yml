parameters:
  - name: installerISO
    displayName: "Image used for the installer, source of trident (container vs host)"
    type: string
    default: trident-installer-testimage
    values:
      - trident-installer-testimage
      - trident-container-installer-testimage

steps:
  - ${{ if eq(parameters.installerISO, 'trident-container-installer-testimage') }}:
      - task: DownloadPipelineArtifact@2
        displayName: "Download Trident container"
        inputs:
          buildType: current
          artifactName: "trident-docker-image"
          patterns: "**/trident-container.tar.gz"
          targetPath: "$(System.ArtifactsDirectory)/container/"

  - task: DownloadPipelineArtifact@2
    displayName: "Download ${{ parameters.installerISO }}"
    inputs:
      buildType: current
      artifactName: "${{ parameters.installerISO }}"
      targetPath: "$(System.ArtifactsDirectory)/"

  - task: DownloadPipelineArtifact@2
    displayName: "Download Trident testimage"
    inputs:
      buildType: current
      artifactName: "trident-testimage"
      targetPath: "$(System.ArtifactsDirectory)/testimage"

  - task: DownloadPipelineArtifact@2
    displayName: "Download verity Trident testimage"
    inputs:
      buildType: current
      artifactName: "trident-verity-testimage"
      targetPath: "$(System.ArtifactsDirectory)/verity-testimage"

  - template: ../testing_common/rename-test-images.yml
    parameters:
      targetDirectory: artifacts/test-image
      testImageDir: $(System.ArtifactsDirectory)/testimage
      verityTestImageDir: $(System.ArtifactsDirectory)/verity-testimage

  - task: DownloadPipelineArtifact@2
    displayName: "Download go-tools"
    inputs:
      buildType: current
      artifactName: "go-tools"
      patterns: |
        netlaunch
        netlisten
      targetPath: "$(Build.SourcesDirectory)/bin/"

  - bash: |
      set -eux

      # Print OS version:
      cat /etc/os-release

      echo "Context:"
      pwd
      ls -la
    displayName: "Print pipeline context"

  - bash: |
      set -eux

      chmod +x "$(Build.SourcesDirectory)/bin/netlaunch"
      chmod +x "$(Build.SourcesDirectory)/bin/netlisten"
    displayName: "Make netlaunch and netlisten executable"

  - bash: |
      set -eux

      for codename in focal jammy; do
        if grep UBUNTU_CODENAME=$codename /etc/os-release -q; then
          sudo add-apt-repository -y ppa:stefanberger/swtpm-$codename
          sudo apt-get -y update

          # This prevents conflict on later install.
          # It fails silently if the packages aren't installed.
          sudo apt-get purge -y swtpm swtpm-tools

          break
        fi
      done
    displayName: "Install SWTPM PPA"
    retryCountOnTaskFailure: 3

  - bash: |
      # Install Docker if it isn't installed
      if ! which docker ; then
        curl -fsSL https://get.docker.com | sudo bash
      fi
    displayName: "Install Docker"
    retryCountOnTaskFailure: 3

  - bash: |
      set -eux

      sudo NEEDRESTART_MODE=a apt-get install -y \
          swtpm \
          swtpm-tools \
          bridge-utils \
          virt-manager \
          qemu-efi \
          qemu-kvm \
          libvirt-daemon-system \
          libvirt-clients \
          python3-libvirt \
          ovmf \
          openssl \
          python3-netifaces \
          python3-docker \
          python3-bcrypt \
          python3-jinja2 \
          zstd
    displayName: Install virt-deploy dependencies
    retryCountOnTaskFailure: 3

  - bash: |
      set -eux

      sudo usermod -aG docker $USER
      sudo usermod -a -G libvirt $USER

      mkdir -p ~/.config/libvirt
      cat << EOF > ~/.config/libvirt/libvirt.conf
      uri_default = "qemu:///system"
      EOF
    displayName: "Configure virt-deploy"
