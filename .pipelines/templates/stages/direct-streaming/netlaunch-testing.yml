parameters:
  - name: testingRun
    displayName: "Download prebuilt test artifacts"
    type: boolean
    default: false

  - name: architecture
    displayName: Architecture
    type: string
    values:
      - arm64
      - amd64
    default: amd64

stages:
  - stage: DirectStreaming_DeploymentTesting_${{ parameters.architecture }}
    displayName: Direct Streaming Deployment VM ${{ parameters.architecture }} Testing
    dependsOn:
      - ${{ if eq(parameters.testingRun, true) }}:
          - DownloadTestingElements
      - ${{ else }}:
          - BuildingTools_${{ parameters.architecture }}
          - BuildTridentContainerImage
          - BuildImagesForDirectStreaming_${{ parameters.architecture }}

    jobs:
      - job: DirectStreamingTesting_${{ parameters.architecture }}
        displayName: Direct Streaming Deployment Testing for ${{ parameters.architecture }}
        timeoutInMinutes: 50
        pool:
          ${{ if eq(parameters.architecture, 'amd64') }}:
            type: linux
            name: trident-ubuntu-1es-pool-eastus2
            hostArchitecture: amd64
          ${{ if eq(parameters.architecture, 'arm64') }}:
            type: linux
            # name: azl3-hci-ARM64-1es-pool-westcentralus
            # name: mariner-hci-ARM64-1es-pool-westcentralus
            name: trident-ubuntu-ARM64-1es-pool-westus2
            hostArchitecture: arm64

        variables:
          - name: tridentSourceDirectory
            value: $(Build.SourcesDirectory)
          - ${{ if eq(parameters.architecture, 'arm64') }}:
            - name: installerISOName
              value: trident-direct-streaming-installer-arm64
            - name: testImageName
              value: trident-direct-streaming-testimage-arm64
          - ${{ if eq(parameters.architecture, 'amd64') }}:
            - name: installerISOName
              value: trident-direct-streaming-installer
            - name: testImageName
              value: trident-direct-streaming-testimage
          - name: ob_outputDirectory
            value: $(tridentSourceDirectory)/deployment_logs
          - name: ob_artifactBaseName
            value: direct_streaming_deployment _${{ parameters.architecture }}_log_$(System.JobAttempt)
          - name: netlaunchPort
            value: 4000

        steps:
          # Download all test images
          - template: ../testing_common/download-test-images.yml
            parameters:
              installerISO: $(installerISOName)
              tridentTestImage: ${{ variables.testImageName }}
              tridentTestImageVerity: skip
              tridentTestImageUsrVerity: skip
              downloadTridentContainer: false
              ${{ if eq(parameters.architecture, 'arm64') }}:
                goToolsArtifactName: go-tools-arm64
              ${{ if eq(parameters.architecture, 'amd64') }}:
                goToolsArtifactName: go-tools

          - bash: |
              set -ex
              sudo apt update -y
              sudo apt install -y python3 python3-pip

              sudo snap install yq

            displayName: "Install pip and yq"
            retryCountOnTaskFailure: 3

          - template: ../testing_vm/netlaunch-prep.yml

          - bash: |
              set -eux

              # Disable virtlogd rollover by setting max_size to 0
              cat /etc/libvirt/virtlogd.conf
              echo "max_size = 0" | sudo tee -a /etc/libvirt/virtlogd.conf
              cat /etc/libvirt/virtlogd.conf
              sudo systemctl restart virtlogd.socket

              ./tools/virt-deploy create --mem 12 --disks 32,32
            workingDirectory: $(tridentSourceDirectory)
            displayName: "Creating virt-deploy VM"

          - bash: |
              set -euxo pipefail

              # Enable SecureBoot for all E2E tests.
              SECURE_BOOT="--secure-boot"
              SERVE_FOLDER=./artifacts/test-image
              NETLAUNCH_CONF=/tmp/vm-netlaunch.yaml

              # Create updated vm-netlaunch.yaml with direct streaming image
              HASH=$(./scripts/cosi-sha384.py $SERVE_FOLDER/regular.cosi)
              (sudo yq '.iso += {"directStreaming": {"image": "regular.cosi", "hash": "ignored"}}' < ./tools/vm-netlaunch.yaml) > $NETLAUNCH_CONF
              sed -i "s|hash: ignored|hash: sha384:$HASH|" $NETLAUNCH_CONF
              cat $NETLAUNCH_CONF

              # Run netlaunch in background to serve the ISO and direct streaming image
              # The deployed image will **not** reach out to netlaunch, so success will be
              # determined by the next task that waits for login in the VM serial output.
              (./bin/netlaunch \
                  --iso ./artifacts/iso/$(installerISOName).iso \
                  --config $NETLAUNCH_CONF \
                  --servefolder $SERVE_FOLDER \
                  --logstream \
                  --trace-file $(tridentSourceDirectory)/trident-clean-install-metrics.jsonl \
                  --force-color \
                  --full-logstream logstream-full.log \
                  $SECURE_BOOT \
                  --port ${{variables.netlaunchPort}} 2>&1 | tee ./direct-streaming-deployment.log) &

              sleep 20

              sudo ./bin/storm-trident helper wait-for-login -a \
                  --vm-name "$(jq -r '.virtualmachines[0].name' $(tridentSourceDirectory)/tools/virt-deploy-metadata.json)" \
                  --artifacts-folder "$(ob_outputDirectory)"

            workingDirectory: $(tridentSourceDirectory)
            displayName: "ðŸš€ Run netlaunch for testing"
            timeoutInMinutes: 20

          - bash: |
              set -eux
              ./bin/storm-trident script capture-screenshot \
                  --screenshot-filename "direct-streaming.png" \
                  --artifacts-folder "$(ob_outputDirectory)"
            displayName: "ðŸ“· Capture screenshot: direct streaming"
            condition: succeededOrFailed()

          - bash: |
              set -eux
              sudo ./bin/storm-trident helper display-logs -a \
                  --serial-log-artifact-file-name "direct-streaming-target-os-A-serial.log" \
                  --trident-trace-log-file "$(tridentSourceDirectory)/logstream-full.log" \
                  --artifacts-folder "$(ob_outputDirectory)"
            displayName: "ðŸ“„ Display direct streaming logs"
            condition: succeededOrFailed()
