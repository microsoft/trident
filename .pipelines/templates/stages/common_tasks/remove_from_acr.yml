parameters:
  - name: "repository"
    displayName: "Repository containing COSI images"
    type: string

  - name: "registry"
    type: string
    default: maritimuspublic

steps:
  - task: AzureCLI@2
    inputs:
      azureSubscription: maritimus-staging-eastus-cr-service-connection
      scriptType: bash
      scriptLocation: inlineScript
      inlineScript: |
        set -eux

        # Login to ACR
        az acr login -n ${{ parameters.registry }}

        repository_name="${{ parameters.repository }}"
        build_id="$(Build.BuildId)"

        # Delete repository with COSI images
        for i in {1..3}; do
          tag="v${build_id}.${i}"

          if az acr repository show --name ${{ parameters.registry }} --image ${repository_name}:${tag} &> /dev/null; then
            az acr repository delete --name ${{ parameters.registry }} --image ${repository_name}:${tag} --yes
          fi
        done
    displayName: "Log into ACR and delete images by tag"
