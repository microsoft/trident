parameters:
  - name: "config"
    displayName: "Trident configuration"
    type: string

  - name: "deploymentEnvironment"
    type: string
    values:
      - virtualMachine
      - bareMetal

steps:
  - bash: |
      set -eux

      if [ ${{ parameters.config }} != 'extensions' ]; then
        echo "Skipping step. Configuration is '${{ parameters.config }}'."
        exit 0
      fi

      ./bin/storm-trident helper build-extension-images --num-clones 2

    displayName: "Build test sysext and confext images"
    workingDirectory: $(Build.SourcesDirectory)
    retryCountOnTaskFailure: 3

  - task: AzureCLI@2
    inputs:
      azureSubscription: trident-dev-acr-write-umi-ECF
      scriptType: bash
      scriptLocation: inlineScript
      inlineScript: |
        set -eux

        if [ ${{ parameters.config }} != 'extensions' ]; then
          echo "Skipping step. Configuration is '${{ parameters.config }}'."
          exit 0
        fi

        ./bin/storm-trident helper push-to-acr \
          --config ${{ parameters.config }} \
          --deployment-environment ${{ parameters.deploymentEnvironment }} \
          --acr-name $(ACR_NAME) \
          --repo-name sysext \
          --build-id $(Build.BuildId) \
          --file-paths $(Build.SourcesDirectory)/test-sysext-1.raw,$(Build.SourcesDirectory)/test-sysext-2.raw

        ./bin/storm-trident helper push-to-acr \
          --config ${{ parameters.config }} \
          --deployment-environment ${{ parameters.deploymentEnvironment }} \
          --acr-name $(ACR_NAME) \
          --repo-name confext \
          --build-id $(Build.BuildId) \
          --file-paths $(Build.SourcesDirectory)/test-confext-1.raw,$(Build.SourcesDirectory)/test-confext-2.raw
    displayName: "Push extension images to ACR"
    retryCountOnTaskFailure: 3
