parameters:
  - name: runVersion
    type: string
    default: latestFromBranch
    displayName: Specific run or latest successful run

  - name: previewContainerPipeline
    type: string
    default: "[AMD64-6-OneBranch]-Prod-BuildImages"
    displayName: Name of preview container pipeline

  - name: baseImagePipelineBuildId
    type: string
    default: ""
    displayName: Build Id of the pipeline run

  - name: dockerfilePath
    type: string
    default: ""
    displayName: File that will be edited to use preview container image
    
  - name: dockerBuildContext
    type: string
    default: $(Build.SourcesDirectory)
    displayName: Path in which the Dockerfile will be run, the base for the container image will be saved there.

steps:
  - template: ../base_image_config/read-base-image-config-artifact.yml
  - bash: |
      set -eux

      RUN_VERSION=$(BASE_IMAGE_PIPELINE_BUILD_ID)
      RUN_TAGS='3.0-preview'
      RUN_ID=''
      if [[ "$RUN_VERSION" != "latestFromBranch" ]]; then
        RUN_VERSION=specific
        RUN_ID=$(BASE_IMAGE_PIPELINE_BUILD_ID)
        RUN_TAGS=''
      fi

      set +x
      echo "##vso[task.setvariable variable=RUN_VERSION]$RUN_VERSION"
      echo "##vso[task.setvariable variable=RUN_ID]$RUN_ID"
    displayName: "Configure RUN_VERSION"
    condition: ne(variables['BASEIMG_BUILD_TYPE'], 'release')

  # BASEIMG_BUILD_TYPE != release
  - task: DownloadPipelineArtifact@2
    displayName: "Download preview of azl container image"
    condition: ne(variables['BASEIMG_BUILD_TYPE'], 'release')
    inputs:
      buildType: "specific"
      project: "mariner"
      pipeline: ${{ parameters.previewContainerPipeline }}
      runVersion: $(RUN_VERSION)
      branchName: "refs/heads/master"
      runId: $(RUN_ID)
      tags: $(RUN_TAGS)
      artifactName: "drop_build_rpms_build"
      patterns: "**/build-artifacts/container_base/core-*.tar.gz"
      targetPath: "$(Pipeline.Workspace)"

  - script: |
      set -eux

      mkdir -p ${{ parameters.dockerBuildContext }}/artifacts/container_base/
      tar -xzvf $(Pipeline.Workspace)/build-artifacts/container_base/core-*.tar.gz -C \
        artifacts/container_base/ > /dev/null 2>&1
      
      sed -i \
        's|^FROM .*|FROM scratch\nCOPY artifacts/container_base/ / \nCMD ["/bin/bash"]|g' \
         ${{ parameters.dockerfilePath }}

      cat ${{ parameters.dockerfilePath }}
    displayName: Replace azl container base with azl preview
    condition: ne(variables['BASEIMG_BUILD_TYPE'], 'release')