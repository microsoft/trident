parameters:
  - name: osModifierBranch
    type: string
    default: "submodule"

steps:
  - bash: |
      set -ex
      if command -v tdnf; then
        # Use msft-golang since it has latest versions supported
        sudo tdnf remove golang -y
        sudo tdnf install msft-golang -y
      else
        sudo snap install --classic go
      fi

      # Verify installation
      go version
    displayName: "Install golang to build Image Customizer"
    retryCountOnTaskFailure: 3
  - bash: |
      set -ex
      git submodule init
      git submodule update

      if [[ "${{ parameters.osModifierBranch }}" != "submodule" ]]; then
        pushd azure-linux-image-tools
        git checkout ${{ parameters.osModifierBranch }}
        git log -1
        popd
      fi

      if command -v tdnf && go version | grep 1.25; then
        # For msft 1.25, set GOEXPERIMENT to nosystemcrypto to
        # enable previous default crypto behavior
        export GOEXPERIMENT=nosystemcrypto
      fi

      mkdir -p artifacts
      mkdir -p azure-linux-image-tools/SPECS
      make -C azure-linux-image-tools/toolkit go-osmodifier REBUILD_TOOLS=y
      rm -rf azure-linux-image-tools/SPECS
      mv azure-linux-image-tools/toolkit/out/tools/osmodifier artifacts/
    displayName: "Build OSModifier"
    workingDirectory: $(Build.SourcesDirectory)
    retryCountOnTaskFailure: 3
