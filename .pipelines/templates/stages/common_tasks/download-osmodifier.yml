parameters:
  - name: osModifierBuildType
    displayName: OSModifier build type to download from osmodifier pipelines
    type: string
    values:
      - main
      - preview
    default: preview

  - name: osModifierVersion
    type: string
    default: "1.1.0-preview.937762"

  - name: targetArchitecture
    type: string
    values:
      - amd64
      - arm64

  - name: osModifierBranch
    displayName: OSModifier branch to build from (if not main)
    type: string
    default: "main"

steps:
  - ${{ if ne(parameters.osModifierBranch, 'main') }}:
    - bash: |
        set -ex
        rm -rf azure-linux-image-tools
        git clone --branch ${{ parameters.osModifierBranch }} https://github.com/microsoft/azure-linux-image-tools azure-linux-image-tools

        mkdir -p artifacts
        make artifacts/osmodifier
      displayName: "Build OSModifier from ${{ parameters.osModifierBranch }}"
      workingDirectory: $(Build.SourcesDirectory)
      retryCountOnTaskFailure: 3

  - ${{ if and(eq(parameters.osModifierBuildType, 'main'), ne(parameters.osModifierVersion, '')) }}:
    - task: DownloadPipelineArtifact@2
      displayName: "Download OSModifier artifact (main - latest)"
      inputs:
        buildType: "specific"
        project: "polar"
        definition: "5139"
        buildVersionToDownload: "latestFromBranch"
        branchName: "refs/heads/user/elaine/add-emu-pipeline"
        artifactName: "osmodifier_${{ parameters.targetArchitecture }}"
        targetPath: "$(Build.SourcesDirectory)/artifacts"

  - ${{ if and(eq(parameters.osModifierBuildType, 'preview'), eq(parameters.targetArchitecture, 'arm64')) }}:
    - task: UniversalPackages@0
      displayName: "Download OSModifier (preview - pinned version for arm64)"
      inputs:
        command: download
        vstsFeed: polar/PolarCoreArtifacts
        vstsFeedPackage: osmodifier_arm64_preview
        vstsPackageVersion: ${{ parameters.osModifierVersion }}
        downloadDirectory: "$(Build.SourcesDirectory)/artifacts"

  - ${{ if and(eq(parameters.osModifierBuildType, 'preview'), ne(parameters.targetArchitecture, 'arm64')) }}:
    - task: UniversalPackages@0
      displayName: "Download OSModifier (preview - pinned version for amd64)"
      inputs:
        command: download
        vstsFeed: polar/PolarCoreArtifacts
        vstsFeedPackage: osmodifier_preview
        vstsPackageVersion: ${{ parameters.osModifierVersion }}
        downloadDirectory: "$(Build.SourcesDirectory)/artifacts"
