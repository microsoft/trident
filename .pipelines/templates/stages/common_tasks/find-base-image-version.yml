steps:
  - template: read-base-image-config-artifact.yml
  - bash: |
      set -eux

      echo "BASEIMG_BUILD_TYPE: $(BASEIMG_BUILD_TYPE)"
      echo "BASE_IMAGE_PIPELINE_BUILD_ID: $(BASE_IMAGE_PIPELINE_BUILD_ID)"
      printenv
    displayName: Show variables before
  
  # baseimgBuildType == dev
  - script: |
      set -eux
      baseimgVersion="*.*.*"
      if [[ "$(BASE_IMAGE_PIPELINE_BUILD_ID)" != "latestFromBranch" ]]; then
        baseimgVersion="$(BASE_IMAGE_PIPELINE_BUILD_ID)"
      fi

      set +x
      echo "##vso[task.setvariable variable=BASEIMG_VERSION]$baseimgVersion"
    name: SetBaseImageVersionDev
    condition: eq(variables['BASEIMG_BUILD_TYPE'], 'dev')
    displayName: Set Base Image version variable for dev

  # baseimgBuildType == release
  - script: |
      set -eux
      baseimgVersion="*.*.*"

      set +x
      echo "##vso[task.setvariable variable=BASEIMG_VERSION]$baseimgVersion"
    name: SetBaseImageVersionRelease
    condition: eq(variables['BASEIMG_BUILD_TYPE'], 'release')
    displayName: Set Base Image version variable for release

  # baseimgBuildType == preview
  - task: DownloadPipelineArtifact@2
    displayName: "Download version-full.config from Prod-BuildImages"
    condition: eq(variables['BASEIMG_BUILD_TYPE'], 'preview')
    inputs:
      buildType: "specific"
      project: "mariner"
      pipeline: "[AMD64-6-OneBranch]-Prod-BuildImages"
      runVersion: specific
      branchName: "refs/heads/master"
      runId: $(BASE_IMAGE_PIPELINE_BUILD_ID)
      tags: "3.0-preview"
      artifactName: "drop_build_rpms_build"
      patterns: "**/build-config/version-full.config"
      targetPath: "$(Build.SourcesDirectory)/output"
  - script: |
      set -eux
      versionFullConfigPath=$(find $(Build.SourcesDirectory) -name version-full.config)
      baseimgVersion=$(cat $versionFullConfigPath)

      set +x
      echo "##vso[task.setvariable variable=BASEIMG_VERSION]$baseimgVersion"
    name: SetBaseImageVersionPreview
    condition: eq(variables['BASEIMG_BUILD_TYPE'], 'preview')
    displayName: Set Base Image version variable for preview

  - bash: |
      set -eux

      echo "BASEIMG_BUILD_TYPE: $(BASEIMG_BUILD_TYPE)"
      echo "BASE_IMAGE_PIPELINE_BUILD_ID: $(BASE_IMAGE_PIPELINE_BUILD_ID)"
      echo "BASEIMG_VERSION: $(BASEIMG_VERSION)"
      printenv
    displayName: Show variables after
