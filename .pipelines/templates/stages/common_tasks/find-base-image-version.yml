  parameters:
  - name: architecture
    displayName: Architecture
    type: string
    values:
      - arm64
      - amd64
    default: "amd64"

  steps:
  - template: ../base_image_config/read-base-image-config-artifact.yml
  - bash: |
      echo "BASEIMG_BUILD_TYPE: $(BASEIMG_BUILD_TYPE)"
      echo "BASE_IMAGE_PIPELINE_BUILD_ID: $(BASE_IMAGE_PIPELINE_BUILD_ID)"
      echo "BASE_IMAGE_ARM64_PIPELINE_BUILD_ID: $(BASE_IMAGE_ARM64_PIPELINE_BUILD_ID)"
    displayName: Show variables before
  
  # baseimgBuildType == dev
  - script: |
      BASEIMG_VERSION="*.*.*"
      if [[ "${{ parameters.architecture }}" == "arm64" ]]; then
        if [[ "$(BASE_IMAGE_ARM64_PIPELINE_BUILD_ID)" != "latestFromBranch" ]]; then
          BASEIMG_VERSION="$(BASE_IMAGE_ARM64_PIPELINE_BUILD_ID)"
        fi
      else
        if [[ "$(BASE_IMAGE_PIPELINE_BUILD_ID)" != "latestFromBranch" ]]; then
          BASEIMG_VERSION="$(BASE_IMAGE_PIPELINE_BUILD_ID)"
        fi
      fi
      echo "##vso[task.setvariable variable=BASEIMG_VERSION]$BASEIMG_VERSION"
      echo "BASEIMG_VERSION: $BASEIMG_VERSION"
    name: SetBaseImageVersionDev
    condition: eq(variables['BASEIMG_BUILD_TYPE'], 'dev')
    displayName: Set Base Image version variable for dev

  # baseimgBuildType == preview
  - script: |
      BASEIMG_PIPELINE_NAME="[AMD64-6-OneBranch]-Prod-BuildImages"
      if [[ "${{ parameters.architecture }}" == "arm64" ]]; then
        BASEIMG_PIPELINE_NAME="[ARM64-6-OneBranch]-Prod-BuildImages"
      fi
      echo "##vso[task.setvariable variable=BASEIMG_PIPELINE_NAME]$BASEIMG_PIPELINE_NAME"
      echo "BASEIMG_PIPELINE_NAME: $BASEIMG_PIPELINE_NAME"

      BASEIMG_VERSION="$(BASE_IMAGE_PIPELINE_BUILD_ID)"
      if [[ "${{ parameters.architecture }}" == "arm64" ]]; then
        BASEIMG_VERSION="$(BASE_IMAGE_ARM64_PIPELINE_BUILD_ID)"
      fi
      echo "##vso[task.setvariable variable=BASEIMG_VERSION]$BASEIMG_VERSION"
      echo "BASEIMG_VERSION: $BASEIMG_VERSION"
      
    condition: eq(variables['BASEIMG_BUILD_TYPE'], 'preview')
    displayName: Set Base Image version variable for preview

  # baseimgBuildType == preview
  - task: DownloadPipelineArtifact@2
    displayName: "Download version-full.config from Prod-BuildImages"
    condition: eq(variables['BASEIMG_BUILD_TYPE'], 'preview')
    inputs:
      buildType: "specific"
      project: "mariner"
      pipeline: $(BASEIMG_PIPELINE_NAME)
      runVersion: specific
      branchName: "refs/heads/master"
      runId: $(BASEIMG_VERSION)
      tags: "3.0-preview"
      artifactName: "drop_build_rpms_build"
      patterns: "**/build-config/version-full.config"
      targetPath: "$(Build.SourcesDirectory)/output"
  - script: |
      versionFullConfigPath=$(find $(Build.SourcesDirectory) -name version-full.config)
      BASEIMG_VERSION=$(cat $versionFullConfigPath)
      echo "##vso[task.setvariable variable=BASEIMG_VERSION]$BASEIMG_VERSION"
      echo "BASEIMG_VERSION: $BASEIMG_VERSION"
    condition: eq(variables['BASEIMG_BUILD_TYPE'], 'preview')
    displayName: Set Base Image version variable for preview

  # baseimgBuildType == release
  - script: |
      BASEIMG_VERSION="*.*.*"
      echo "##vso[task.setvariable variable=BASEIMG_VERSION]$BASEIMG_VERSION"
      echo "BASEIMG_VERSION: $BASEIMG_VERSION"
    name: SetBaseImageVersionRelease
    condition: eq(variables['BASEIMG_BUILD_TYPE'], 'release')
    displayName: Set Base Image version variable for release

  - bash: |
      echo "BASEIMG_BUILD_TYPE: $(BASEIMG_BUILD_TYPE)"
      echo "BASE_IMAGE_PIPELINE_BUILD_ID: $(BASE_IMAGE_PIPELINE_BUILD_ID)"
      echo "BASEIMG_VERSION: $(BASEIMG_VERSION)"
    displayName: Show variables after
