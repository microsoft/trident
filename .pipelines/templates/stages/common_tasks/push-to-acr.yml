parameters:
  - name: "imageName"
    displayName: "Test image name, doubling as repository name"
    type: string
    values:
      - trident-testimage
      - trident-container-testimage

  - name: "config"
    displayName: "Trident configuration"
    type: string

  - name: "deploymentEnvironment"
    type: string
    values:
      - virtualMachine
      - bareMetal

  - name: "runtimeEnvironment"
    type: string
    values:
      - container
      - host

steps:
  - bash: |
      set -eux

      if [ "${{ parameters.config }}" == 'extensions' ]; then
        ./bin/storm-trident script build-extension-images --build-sysexts --num-clones 2
      elif [ "${{ parameters.config }}" == 'root-verity' ]; then
        ./bin/storm-trident script build-extension-images --build-sysexts --build-confexts --num-clones 2
      else
        echo "Skipping step. Configuration is '${{ parameters.config }}'."
        exit 0
      fi

    displayName: "Build test sysext and confext images"
    workingDirectory: $(Build.SourcesDirectory)
    retryCountOnTaskFailure: 3

  - bash: |
      set -eux
      if [ "${{ parameters.config }}" != 'misc' ] && [ "${{ parameters.config }}" != 'extensions' ] && [ "${{ parameters.config }}" != 'root-verity' ]; then
        echo "Skipping step. Configuration is '${{ parameters.config }}'."
        exit 0
      fi

      VERSION="1.2.2"
      curl -LO "https://github.com/oras-project/oras/releases/download/v${VERSION}/oras_${VERSION}_linux_amd64.tar.gz"
      mkdir -p oras-install/
      tar -zxf oras_${VERSION}_*.tar.gz -C oras-install/
      sudo mv oras-install/oras /usr/local/bin/
      rm -rf oras_${VERSION}_*.tar.gz oras-install/
    displayName: "Install ORAS"
    retryCountOnTaskFailure: 3

  - task: AzureCLI@2
    inputs:
      azureSubscription: trident-dev-acr-write-umi-ECF
      scriptType: bash
      scriptLocation: inlineScript
      inlineScript: |
        set -eux

        if [ "${{ parameters.config }}" == 'misc' ]; then
          ./bin/storm-trident script acr-push \
            --config ${{ parameters.config }} \
            --deployment-environment ${{ parameters.deploymentEnvironment }} \
            --acr-name $(ACR_NAME) \
            --repo-name ${{ parameters.imageName }} \
            --build-id $(Build.BuildId) \
            --file-paths $(Build.SourcesDirectory)/artifacts/test-image/regular.cosi \
            --file-paths $(Build.SourcesDirectory)/artifacts/test-image/regular_v2.cosi \
            --file-paths $(Build.SourcesDirectory)/artifacts/test-image/regular_v3.cosi \
            --file-paths $(Build.SourcesDirectory)/artifacts/test-image/regular_v4.cosi \
            --tag-var-name TAG_BASE

        elif [ "${{ parameters.config }}" == 'extensions' ]; then
          ./bin/storm-trident script acr-push \
            --config ${{ parameters.config }} \
            --deployment-environment ${{ parameters.deploymentEnvironment }} \
            --acr-name $(ACR_NAME) \
            --repo-name sysext-${{ parameters.runtimeEnvironment }} \
            --build-id $(Build.BuildId) \
            --file-paths $(Build.SourcesDirectory)/test-sysext-1.raw \
            --file-paths $(Build.SourcesDirectory)/test-sysext-2.raw \
            --tag-var-name TAG_BASE \
            --repo-var-name SYSEXT_REPO

        elif [ "${{ parameters.config }}" == 'root-verity' ]; then
          ./bin/storm-trident script acr-push \
            --config ${{ parameters.config }} \
            --deployment-environment ${{ parameters.deploymentEnvironment }} \
            --acr-name $(ACR_NAME) \
            --repo-name sysext-${{ parameters.runtimeEnvironment }} \
            --build-id $(Build.BuildId) \
            --file-paths $(Build.SourcesDirectory)/test-sysext-1.raw \
            --file-paths $(Build.SourcesDirectory)/test-sysext-2.raw \
            --tag-var-name TAG_BASE \
            --repo-var-name SYSEXT_REPO
            
          ./bin/storm-trident script acr-push \
            --config ${{ parameters.config }} \
            --deployment-environment ${{ parameters.deploymentEnvironment }} \
            --acr-name $(ACR_NAME) \
            --repo-name confext-${{ parameters.runtimeEnvironment }} \
            --build-id $(Build.BuildId) \
            --file-paths $(Build.SourcesDirectory)/test-confext-1.raw \
            --file-paths $(Build.SourcesDirectory)/test-confext-2.raw \
            --tag-var-name TAG_BASE \
            --repo-var-name CONFEXT_REPO

        else
          echo "Skipping step. Configuration is '${{ parameters.config }}'."
          exit 0
        fi

    displayName: "Push to ACR"
    retryCountOnTaskFailure: 3
