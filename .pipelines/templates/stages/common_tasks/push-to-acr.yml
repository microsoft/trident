parameters:
  - name: "imageName"
    displayName: "Test image name, doubling as repository name"
    type: string
    values:
      - trident-testimage
      - trident-container-testimage

  - name: "config"
    displayName: "Trident configuration"
    type: string

  - name: "deploymentEnvironment"
    type: string
    values:
      - virtualMachine
      - bareMetal

steps:
  - task: AzureCLI@2
    inputs:
      azureSubscription: trident-dev-acr-write-umi-ECF
      scriptType: bash
      scriptLocation: inlineScript
      inlineScript: |
        set -eux

        if [ ${{ parameters.config }} != 'misc' ]; then
          echo "Skipping step. Configuration is '${{ parameters.config }}'."
          exit 0
        fi

        ./bin/storm-trident helper push-to-acr \
          --config ${{ parameters.config }} \
          --deployment-environment ${{ parameters.deploymentEnvironment }} \
          --acr-name $(ACR_NAME) \
          --repo-name ${{ parameters.imageName }} \
          --build-id $(Build.BuildId) \
          --file-paths $(Build.SourcesDirectory)/artifacts/test-image/regular.cosi \
          --file-paths $(Build.SourcesDirectory)/artifacts/test-image/regular_v2.cosi \
          --file-paths $(Build.SourcesDirectory)/artifacts/test-image/regular_v3.cosi \
          --file-paths $(Build.SourcesDirectory)/artifacts/test-image/regular_v4.cosi
    displayName: "Push COSI to ACR"
    retryCountOnTaskFailure: 3
