parameters:
  - name: adoProjectName
    type: string
    values:
      - polar
      - ECF

  - name: "imageName"
    displayName: "Test image name, doubling as repository name"
    type: string
    values:
      - trident-testimage
      - trident-container-testimage

  - name: "config"
    displayName: "Trident configuration"
    type: string

  - name: "deploymentEnvironment"
    type: string
    values:
      - virtualMachine
      - bareMetal

  - name: "runtimeEnvironment"
    type: string
    values:
      - container
      - host

steps:
  - bash: |
      set -eux

      if [ "${{ parameters.config }}" == 'extensions' ]; then
        ./bin/storm-trident script build-extension-images --build-sysexts --num-clones 2
      else
        echo "Skipping step. Configuration is '${{ parameters.config }}'."
        exit 0
      fi

    displayName: "Build test sysext and confext images"
    workingDirectory: $(TRIDENT_SOURCE_DIR)
    retryCountOnTaskFailure: 3

  - bash: |
      set -eux
      if [ "${{ parameters.config }}" != 'misc' ] && [ "${{ parameters.config }}" != 'extensions' ]; then
        echo "Skipping step. Configuration is '${{ parameters.config }}'."
        exit 0
      fi

      VERSION="1.2.2"
      curl -LO "https://github.com/oras-project/oras/releases/download/v${VERSION}/oras_${VERSION}_linux_amd64.tar.gz"
      mkdir -p oras-install/
      tar -zxf oras_${VERSION}_*.tar.gz -C oras-install/
      sudo mv oras-install/oras /usr/local/bin/
      rm -rf oras_${VERSION}_*.tar.gz oras-install/
    displayName: "Install ORAS"
    retryCountOnTaskFailure: 3

  - ${{ if eq(parameters.adoProjectName, 'polar') }}:
      - task: AzureCLI@2
        inputs:
          azureSubscription: maritimus-dev-acr-write-umi
          scriptType: bash
          scriptLocation: inlineScript
          inlineScript: |
            set -eux

            cd $(TRIDENT_SOURCE_DIR)
            if [ "${{ parameters.config }}" == 'misc' ]; then
              ./bin/storm-trident script acr-push \
                --config ${{ parameters.config }} \
                --deployment-environment ${{ parameters.deploymentEnvironment }} \
                --acr-name $(ACR_NAME) \
                --repo-name ${{ parameters.imageName }} \
                --build-id $(Build.BuildId) \
                --file-paths $(TRIDENT_SOURCE_DIR)/artifacts/test-image/regular.cosi \
                --file-paths $(TRIDENT_SOURCE_DIR)/artifacts/test-image/regular_v2.cosi \
                --file-paths $(TRIDENT_SOURCE_DIR)/artifacts/test-image/regular_v3.cosi \
                --file-paths $(TRIDENT_SOURCE_DIR)/artifacts/test-image/regular_v4.cosi \
                --tag-var-name TAG_BASE

            elif [ "${{ parameters.config }}" == 'extensions' ]; then
              ./bin/storm-trident script acr-push \
                --config ${{ parameters.config }} \
                --deployment-environment ${{ parameters.deploymentEnvironment }} \
                --acr-name $(ACR_NAME) \
                --repo-name sysext-${{ parameters.runtimeEnvironment }} \
                --build-id $(Build.BuildId) \
                --file-paths $(TRIDENT_SOURCE_DIR)/test-sysext-1.raw \
                --file-paths $(TRIDENT_SOURCE_DIR)/test-sysext-2.raw \
                --tag-var-name TAG_BASE \
                --repo-var-name SYSEXT_REPO

            else
              echo "Skipping step. Configuration is '${{ parameters.config }}'."
              exit 0
            fi

        displayName: "Push to ACR"
        retryCountOnTaskFailure: 3

  - ${{ if eq(parameters.adoProjectName, 'ECF') }}:
      - task: AzureCLI@2
        inputs:
          azureSubscription: trident-dev-acr-write-umi-ECF
          scriptType: bash
          scriptLocation: inlineScript
          inlineScript: |
            set -eux

            cd $(TRIDENT_SOURCE_DIR)
            if [ "${{ parameters.config }}" == 'misc' ]; then
              ./bin/storm-trident script acr-push \
                --config ${{ parameters.config }} \
                --deployment-environment ${{ parameters.deploymentEnvironment }} \
                --acr-name $(ACR_NAME) \
                --repo-name ${{ parameters.imageName }} \
                --build-id $(Build.BuildId) \
                --file-paths $(TRIDENT_SOURCE_DIR)/artifacts/test-image/regular.cosi \
                --file-paths $(TRIDENT_SOURCE_DIR)/artifacts/test-image/regular_v2.cosi \
                --file-paths $(TRIDENT_SOURCE_DIR)/artifacts/test-image/regular_v3.cosi \
                --file-paths $(TRIDENT_SOURCE_DIR)/artifacts/test-image/regular_v4.cosi \
                --tag-var-name TAG_BASE

            elif [ "${{ parameters.config }}" == 'extensions' ]; then
              ./bin/storm-trident script acr-push \
                --config ${{ parameters.config }} \
                --deployment-environment ${{ parameters.deploymentEnvironment }} \
                --acr-name $(ACR_NAME) \
                --repo-name sysext-${{ parameters.runtimeEnvironment }} \
                --build-id $(Build.BuildId) \
                --file-paths $(TRIDENT_SOURCE_DIR)/test-sysext-1.raw \
                --file-paths $(TRIDENT_SOURCE_DIR)/test-sysext-2.raw \
                --tag-var-name TAG_BASE \
                --repo-var-name SYSEXT_REPO

            else
              echo "Skipping step. Configuration is '${{ parameters.config }}'."
              exit 0
            fi

        displayName: "Push to ACR"
        retryCountOnTaskFailure: 3
