# TRIDENT PLATFORM CICD TEMPLATE
# This template is used by the platform-cicd-preview pipeline to
# build and test trident deployment scenarios for a specified AZL
# preview build.

parameters:
  - name: baremetalTestsEnabled
    type: boolean
    default: false

  - name: baseImageArtifactStage
    type: string
  
  - name: targetArchitecture
    type: string
    values:
      - amd64
      - arm64

  - name: tridentBinariesArtifactPrecreated
    type: boolean
    default: false

  - name: acrServiceConnection
    type: string
    default: maritimus-dev-acr-write-umi
    values:
      - trident-dev-acr-write-umi-ECF
      - maritimus-dev-acr-write-umi

stages:
  - ${{ if eq( parameters.targetArchitecture, 'amd64') }}:
    - template: e2e-template.yml
      parameters:
        stageType: pre
        blockPublishing: true
        forceTridentRebuild: true
        forceFunctionalTestImageRebuild: true
        baremetalTestsEnabled: ${{ parameters.baremetalTestsEnabled }}
        baseImageArtifactStage: ${{ parameters.baseImageArtifactStage }}
        tridentBinariesArtifactPrecreated: ${{ parameters.tridentBinariesArtifactPrecreated }}
        acrServiceConnection: ${{ parameters.acrServiceConnection }}

  - ${{ if eq( parameters.targetArchitecture, 'arm64') }}:
    - template: e2e-arm64-template.yml
      parameters:
        stageType: pre
        forceTridentRebuild: true
        baseImageArtifactStage: ${{ parameters.baseImageArtifactStage }}
