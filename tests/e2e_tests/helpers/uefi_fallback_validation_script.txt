EFI_PATH="/boot/efi/EFI"
FALLBACK_PATH="$EFI_PATH/BOOT"

EFI_OUTPUT="$(efibootmgr)"
echo "$EFI_OUTPUT"

CURRENT_BOOT="$(echo -e "$EFI_OUTPUT" | grep "BootCurrent" | head -n 1)"
if [ -z "$CURRENT_BOOT" ]; then
    echo "Failed to get current boot entry"
    exit 1
fi

CURRENT_BOOT_ENTRY="$(echo "$CURRENT_BOOT" | awk '{print $2}')"
if [ -z "$CURRENT_BOOT_ENTRY" ]; then
    echo "Failed to parse current boot entry"
    exit 1
fi

CURRENT_AZL_BOOT_NAME="$(echo -e "$EFI_OUTPUT" | grep "Boot${CURRENT_BOOT_ENTRY}" | head -n 1 | awk '{print $2}' | grep "AZL")"
if [ -z "$CURRENT_AZL_BOOT_NAME" ]; then
    echo "Current boot entry is not an AZL boot entry"
    exit 1
fi

if [ "_REPLACE_FALLBACK_NODE_" == "none" ]; then
    # if none, check that $FALLBACK_PATH is empty
    if sudo find $FALLBACK_PATH/*; then
        echo "$FALLBACK_PATH is not empty"
        exit 1
    else
        echo "$FALLBACK_PATH is empty"
        exit 0
    fi
else
    AZL_BOOT_NAME_TO_CHECK="$CURRENT_AZL_BOOT_NAME"
    if [ "_REPLACE_FALLBACK_NODE_" == "rollback" ] && _REPLACE_NOT_INSTALL_; then
        # if rollback, check that $FALLBACK_PATH == opposite of $EFI_PATH/$CURRENT_AZL_BOOT_NAME
        AZL_BOOT_NAME_TO_CHECK="$(echo "$CURRENT_AZL_BOOT_NAME" | sed "s/AZLA/AZLA_TMP/g; s/AZLB/AZLA/g; s/AZLA_TMP/AZLB/g")"
    fi

    if diff "$FALLBACK_PATH/" "$EFI_PATH/$AZL_BOOT_NAME_TO_CHECK/"; then
        echo "no difference detected between $FALLBACK_PATH and $EFI_PATH/$AZL_BOOT_NAME_TO_CHECK/"
        exit 0
    else
        echo "difference detected between $FALLBACK_PATH and $EFI_PATH/$AZL_BOOT_NAME_TO_CHECK/"
        exit 1
    fi
fi
