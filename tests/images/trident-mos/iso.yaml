storage:
  bootType: efi

  disks:
    - partitionTableType: gpt
      maxSize: 4G
      partitions:
        - id: esp
          type: esp
          start: 1M
          end: 9M

        - id: rootfs
          start: 9M
  filesystems:
    - deviceId: esp
      type: fat32
      mountPoint:
        path: /boot/efi
        options: umask=0077

    - deviceId: rootfs
      type: ext4
      mountPoint:
        path: /

os:
  bootloader:
    resetType: hard-reset
  hostname: trident-mos-testimage

  packages:
    update:
      - systemd

    install:
      - binutils
      - curl
      - device-mapper
      - dnf
      - dosfstools
      - efibootmgr
      - iproute
      - iptables
      - lsof
      - mdadm
      - netplan
      # Support for mounting NTFS filesystems
      - ntfs-3g
      # Support for creating NTFS filesystems
      - ntfsprogs
      - openssh-server
      - squashfs-tools
      - tar
      - tpm2-tools
      - veritysetup
      - vim
      # Support for building SELinux module and debugging
      - selinux-policy-devel
      - setools-console

  additionalDirs:
    # Required for systemd-pcrlock & PCR-based encryption; can be removed once
    # AZL 4.0 merges a fix to provide statically defined files inside the same
    # package as the systemd-pcrlock binary, i.e. systemd-udev.
    - source: "../../../packaging/static-pcrlock-files/"
      destination: "/var/lib/pcrlock.d/"

  additionalFiles:
    - source: files/getty@.service
      destination: /usr/lib/systemd/system/getty@.service
    - source: files/serial-getty@.service
      destination: /usr/lib/systemd/system/serial-getty@.service
    - source: files/root.profile
      destination: /root/.profile
    - source: ../../../packaging/systemd/trident-install.service
      destination: /usr/lib/systemd/system/trident-install.service
    - source: ../../../packaging/selinux-policy-trident/trident.if
      destination: /usr/share/selinux/packages/trident/trident.if
    - source: ../../../packaging/selinux-policy-trident/trident.fc
      destination: /usr/share/selinux/packages/trident/trident.fc
    - source: ../../../packaging/selinux-policy-trident/trident.te
      destination: /usr/share/selinux/packages/trident/trident.te

    # Trident daemon service files
    - source: ../../../packaging/systemd/tridentd.socket
      destination: /usr/lib/systemd/system/tridentd.socket
    - source: ../../../packaging/systemd/tridentd.service
      destination: /usr/lib/systemd/system/tridentd.service

    # Netlaunch RCP files
    - source: ../../../bin/rcp-agent
      destination: /usr/bin/rcp-agent
    - source: ../../../tools/cmd/rcp-agent/rcp-agent.service
      destination: /usr/lib/systemd/system/rcp-agent.service

  services:
    enable:
      - rcp-agent
      - tridentd.socket
    disable:
      - trident-install

scripts:
  postCustomization:
    - path: post-install.sh

iso:
  additionalFiles:
    # Add placeholder config for Trident
    - source: files/config-placeholder.yaml
      destination: /trident-config.yaml
    # Add pre-trident script to be run early by rcp-agent
    - source: files/pre-trident-script.sh
      destination: /pre-trident-script.sh
    # Add overridable default config for rcp-agent
    - source: files/rcp-agent.yaml
      destination: /rcp-agent.yaml

  kernelCommandLine:
    extraCommandLine:
      - console=tty0
      - console=ttyS0
      - rd.luks=0
      - selinux=1
      - enforcing=0
