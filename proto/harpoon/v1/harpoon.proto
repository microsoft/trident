// Proto file defining the TridentService and related messages.

syntax = "proto3";

package harpoon.v1;

import "google/protobuf/timestamp.proto";

// TridentService provides methods for managing Trident servicing operations
service TridentService {
  // Install performs an OS installation.
  rpc Install(ServicingRequest) returns (stream ServicingResponse);

  // InstallStage performs the stage operation of an OS installation.
  rpc InstallStage(StageRequest) returns (stream ServicingResponse);

  // InstallFinalize performs the finalize operation of an OS installation.
  rpc InstallFinalize(FinalizeRequest) returns (stream ServicingResponse);

  // Update performs an OS update.
  rpc Update(ServicingRequest) returns (stream ServicingResponse);

  // UpdateStage performs the stage operation of an OS update.
  rpc UpdateStage(StageRequest) returns (stream ServicingResponse);

  // UpdateFinalize performs the finalize operation of an OS update.
  rpc UpdateFinalize(FinalizeRequest) returns (stream ServicingResponse);

  // CheckRollback checks what type of rollback would be performed.
  rpc CheckRollback(CheckRollbackRequest) returns (CheckRollbackResponse);

  // Rollback performs a rollback.
  rpc Rollback(RollbackRequest) returns (stream ServicingResponse);

  // RollbackStage performs the stage operation of a rollback.
  rpc RollbackStage(RollbackStageRequest) returns (stream ServicingResponse);

  // RollbackFinalize performs the finalize operation of a rollback.
  rpc RollbackFinalize(RollbackFinalizeRequest) returns (stream ServicingResponse);

  // CheckRoot validates that the host booted using the expected root
  // filesystem.
  rpc CheckRoot(CheckRootRequest) returns (stream ServicingResponse);

  // Commit attempts the commit operation to finalize a servicing.
  rpc Commit(CommitRequest) returns (stream ServicingResponse);

  // StreamImage streams an OS image to the target device.
  rpc StreamImage(StreamImageRequest) returns (stream ServicingResponse);

  // RebuildRaid performs a RAID rebuild operation to restore a degraded RAID
  // array on new disks.
  rpc RebuildRaid(RebuildRaidRequest) returns (stream ServicingResponse);

  // ValidateHostConfiguration performs static validation of a Host Configuration.
  rpc ValidateHostConfiguration(ValidateHostConfigurationRequest) returns (ValidateHostConfigurationResponse);

  // GetServicingType returns the servicing type that would be required to apply
  // the given Host Configuration.
  rpc GetRequiredServicingType(GetRequiredServicingTypeRequest) returns (GetRequiredServicingTypeResponse);

  // GetProvisionedConfig returns the currently provisioned configuration, if any.
  rpc GetProvisionedConfig(GetConfigRequest) returns (GetConfigResponse);

  // GetServicingConfig returns the active servicing configuration, if any.
  rpc GetServicingConfig(GetConfigRequest) returns (GetConfigResponse);

  // GetLastError returns the last error encountered during the last servicing,
  // if any.
  rpc GetLastError(GetLastErrorRequest) returns (GetLastErrorResponse);

  // GetServicingState returns the current servicing state.
  rpc GetServicingState(GetServicingStateRequest) returns (GetServicingStateResponse);

  // GetActiveVolume returns the currently active volume (A or B).
  rpc GetActiveVolume(GetActiveVolumeRequest) returns (GetActiveVolumeResponse);

  // GetRollbackChain returns list of available rollbacks.
  rpc GetRollbackChain(GetRollbackChainRequest) returns (GetRollbackChainResponse);

  // GetRollbackTarget returns the next rollback target OS Host Configuration.
  rpc GetRollbackTarget(GetRollbackTargetRequest) returns (GetRollbackTargetResponse);

  // Version returns the Trident version.
  rpc Version(VersionRequest) returns (VersionResponse);
}

message StageRequest {
  // The target Host Configuration.
  string config = 1;
}

message FinalizeRequest {
  // Indicates whether the orchestrator will handle any required reboots of the
  // system. When set to false, Trident will perform any necessary reboots
  // itself. When set to true, Trident will complete the servicing operation
  // without rebooting, and will expect the orchestrator to reboot the system
  // immediately after finalization, when requested.
  bool orchestrator_handles_reboot = 1;
}

message ServicingRequest {
  // The staging parameters for the servicing operation.
  StageRequest stage = 1;
  // The finalize parameters for the servicing operation.
  FinalizeRequest finalize = 2;
}

// Rust log levels
enum LogLevel {
  LOG_LEVEL_UNSPECIFIED = 0;
  LOG_LEVEL_ERROR       = 1;
  LOG_LEVEL_WARN        = 2;
  LOG_LEVEL_INFO        = 3;
  LOG_LEVEL_DEBUG       = 4;
  LOG_LEVEL_TRACE       = 5;
}

message Log {
  // Level of the log message.
  LogLevel level = 1;
  // Body of the log message.
  string message = 2;
  // Target of the log message.
  string target = 3;
  // Module where the log message originated.
  string module = 4;
  // Location where the log message was generated.
  FileLocation location = 5;
}

// Represents the final status of a servicing operation.
enum StatusCode {
  STATUS_CODE_UNSPECIFIED = 0;
  STATUS_CODE_SUCCESS     = 1;
  STATUS_CODE_FAILURE     = 2;
}

message FinalStatus {
  // Final status of the servicing operation.
  StatusCode status = 1;
  // Message associated with the final status.
  optional TridentError error = 2;
  // Whether a reboot is required to complete the servicing operation. If true,
  // the caller is expected to reboot the system to finalize the servicing
  // immediately upon receiving this status.
  bool reboot_required = 3;
  // Whether the servicing operation enqueued a reboot. If true, the system is
  // expected to reboot automatically to finalize the servicing. No further
  // action from the caller is needed. This field can be true only if
  // reboot_required is false.
  bool reboot_enqueued = 4;
}

message Start {}

message ServicingResponse {
  // Timestamp of the response message.
  google.protobuf.Timestamp timestamp = 1;
  // Body of the response message.
  oneof response {
    // A start message indicating the beginning of the servicing operation.
    Start start = 2;
    // A log message from the servicing operation.
    Log log = 3;
    // A final status message from the servicing operation.
    FinalStatus final_status = 4;
  }
}

message GetConfigRequest {}

message GetConfigResponse {
  // The Host Configuration content as a string.
  optional string config = 1;
}

message GetLastErrorRequest {}

message GetLastErrorResponse {
  // The last error encountered during servicing.
  optional TridentError error = 1;
}

message GetServicingStateRequest {}

// Mapped to existing Trident servicing states
enum ServicingState {
  SERVICING_STATE_UNSPECIFIED = 0;
  NOT_PROVISIONED             = 1;
  INSTALL_STAGED              = 2;
  UPDATE_STAGED               = 3;
  INSTALL_FINALIZED           = 4;
  UPDATE_FINALIZED            = 5;
  PROVISIONED                 = 6;
}

message GetServicingStateResponse {
  // The current servicing state of Trident.
  ServicingState state = 1;
}

message GetActiveVolumeRequest {}

// Represents the active volume in a dual-volume setup.
enum ABVolumeState {
  AB_VOLUME_STATE_UNSPECIFIED = 0;
  NO_VOLUME                   = 1;
  VOLUME_A                    = 2;
  VOLUME_B                    = 3;
}

message GetActiveVolumeResponse {
  ABVolumeState active_volume = 1;
}

message ValidateHostConfigurationRequest {
  // The Host Configuration to be validated.
  string config = 1;
}

message ValidateHostConfigurationResponse {
  // Whether the configuration is valid.
  bool ok = 1;
  // Validation error, if any. Nil if the configuration is valid.
  optional TridentError error = 2;
}

enum ServicingType {
  SERVICING_TYPE_UNSPECIFIED = 0;
  // No servicing is currently in progress or not required.
  NO_ACTIVE_SERVICING = 1;
  // Update that can be applied without necessitating a reboot.
  RUNTIME_UPDATE = 2;
  // Update that requires switching to a different root partition and rebooting.
  AB_UPDATE = 3;
  // Clean install of the target OS.
  CLEAN_INSTALL = 4;
}

message GetRequiredServicingTypeRequest {
  // The target Host Configuration.
  string config = 1;
}

message GetRequiredServicingTypeResponse {
  // The type of servicing required.
  ServicingType servicing_type = 1;
}

enum ManualRollbackKind {
  MANUAL_ROLLBACK_KIND_UNSPECIFIED = 0;
  // No specific rollback kind was requested
  ANY_ROLLBACK_REQUESTED = 1;
  // Rollback of an A/B update was requested
  AB_ROLLBACK_REQUESTED = 2;
  // Rollback of a runtime update was requested
  RUNTIME_ROLLBACK_REQUESTED = 3;
}

message CheckRollbackRequest {
  // The rollback kind parameter for the servicing operation.
  ManualRollbackKind kind = 1;
}

enum CheckRollbackKind {
  CHECK_ROLLBACK_KIND_UNSPECIFIED = 0;
  // No rollbacks are available
  NO_ROLLBACK_AVAILABLE = 1;
  // Rollback of an A/B update is expected
  AB_ROLLBACK_EXPECTED = 2;
  // Rollback of a runtime update is expected
  RUNTIME_ROLLBACK_EXPECTED = 3;
}

message CheckRollbackResponse {
  // The rollback kind as a string.
  CheckRollbackKind kind = 1;
}

message RollbackRequest {
  // The finalize parameters for the servicing operation.
  FinalizeRequest finalize = 2;
  // The rollback kind parameter for the servicing operation.
  ManualRollbackKind kind = 3;
}

message RollbackStageRequest {
  // The rollback kind parameter for the servicing operation.
  ManualRollbackKind kind = 3;
}

message RollbackFinalizeRequest {
  // The finalize parameters for the servicing operation.
  FinalizeRequest finalize = 2;
}

message GetRollbackChainRequest {}

message GetRollbackChainResponse {
  // The rollback list content as a list of strings.
  repeated string rollback_chain = 1;
}

message GetRollbackTargetRequest {}

message GetRollbackTargetResponse {
  // The rollback target Host Configuration content as a string.
  optional string rollback_target = 1;
}

message CheckRootRequest {}

message CommitRequest {}

message RebuildRaidRequest {}

message StreamImageRequest {
  // Path to the image file to be streamed.
  string image_path = 1;
  // Hash of the image file for integrity verification.
  string image_hash = 2;
  // The finalize parameters for the servicing operation.
  FinalizeRequest finalize = 3;
}

message TridentError {
  // Error kind.
  TridentErrorKind kind = 1;
  // Error subkind.
  string subkind = 2;
  // Specific error message.
  string message = 3;
  // Full formatted body of the error, including context and source.
  string full_body = 4;
  // Location in the file where the error occurred.
  FileLocation location = 5;
}

// Major kinds of Trident errors.
enum TridentErrorKind {
  TRIDENT_ERROR_KIND_UNSPECIFIED = 0;
  // Identifies errors that occur when the execution environment is
  // misconfigured.
  EXECUTION_ENVIRONMENT_MISCONFIGURATION_ERROR = 1;
  // Identifies errors that are related to health checks.
  HEALTH_CHECKS_ERROR = 2;
  // Identifies errors that occur when Trident fails to initialize.
  INITIALIZATION_ERROR = 3;
  // Identifies errors that occur due to an internal bug or failure in Trident.
  INTERNAL_ERROR = 4;
  // Identifies errors that occur when the user provides invalid input.
  INVALID_INPUT_ERROR = 5;
  // Identifies errors that occur during servicing and require further user
  // investigation, to determine whether the error occurred due to an internal
  // failure in Trident, a failure in one of its dependencies, or a system
  // misconfiguration.
  SERVICING_ERROR = 6;
  // Identifies errors that occur when clean install or update fail due to the
  // current configuration of the host.
  UNSUPPORTED_CONFIGURATION_ERROR = 7;
}

message FileLocation {
  // Path to the file.
  string path = 1;
  // Line number in the file.
  uint32 line = 2;
}

message VersionRequest {}

message VersionResponse {
  // Trident version string.
  string version = 1;
}