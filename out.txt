git clone https://github.com/microsoft/azure-linux-image-tools
pushd azure-linux-image-tools
make go-imagecustomizer REBUILD_TOOLS=y -C ./toolkit
ARCH=amd64
if uname -a | grep aarch64; then
  ARCH=arm64
fi
./toolkit/tools/imagecustomizer/container/build-container.sh -t imagecustomizer:dev -a "${arch}"
popd

git clone https://github.com/microsoft/trident
cd trident
git checkout user/bfjelds/direct-streaming-test-fairwater
sudo apt install -y make
sudo add-apt-repository ppa:longsleep/golang-backports
sudo apt update
sudo apt install -y golang-go

# az cli
curl -L https://aka.ms/InstallAzureCli | bash
exec -l $SHELL

# docker
sudo apt update
sudo apt install ca-certificates curl
sudo install -m 0755 -d /etc/apt/keyrings
sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
sudo chmod a+r /etc/apt/keyrings/docker.asc
sudo tee /etc/apt/sources.list.d/docker.sources <<EOF
Types: deb
URIs: https://download.docker.com/linux/ubuntu
Suites: $(. /etc/os-release && echo "${UBUNTU_CODENAME:-$VERSION_CODENAME}")
Components: stable
Signed-By: /etc/apt/keyrings/docker.asc
EOF
sudo apt update
sudo apt install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
sudo groupadd docker
sudo usermod -aG docker $USER
newgrp docker

# Rust
curl https://sh.rustup.rs -sSf | sh
. "$HOME/.cargo/env"

# Package dependencies
sudo apt-get install -y \
    virt-manager \
    qemu-efi \
    python3-libvirt \
    ovmf \
    openssl \
    python3-netifaces \
    python3-docker \
    python3-bcrypt \
    python3-jinja2 \
    swtpm \
    swtpm-tools \
    curl

  sudo apt-get install -y \
      swtpm \
      swtpm-tools \
      bridge-utils \
      virt-manager \
      qemu-efi \
      qemu-kvm \
      libtpms0 \
      libvirt-daemon-system \
      libvirt-clients \
      python3-libvirt \
      ovmf \
      openssl \
      python3-netifaces \
      python3-docker \
      python3-bcrypt \
      python3-jinja2 \
      zstd

sudo usermod -a -G libvirt $USER

sudo apt-get install -y libssl-dev
sudo apt-get install -y protobuf-compiler
sudo apt-get install -y python3-pip

sudo pip install virt-firmware

sudo snap install yq


PB_REL="https://github.com/protocolbuffers/protobuf/releases"
if uname -a | grep x86_64; then
  curl -LO $PB_REL/download/v30.2/protoc-30.2-linux-x86_64.zip
  unzip protoc-30.2-linux-x86_64.zip -d $HOME/.local
fi
if uname -a | grep aarch64; then
  curl -LO $PB_REL/download/v30.2/protoc-30.2-linux-aarch_64.zip
  unzip protoc-30.2-linux-aarch_64.zip -d $HOME/.local
fi

export PATH="$HOME/.local/bin:$PATH"

make bin/netlaunch
make bin/mkcosi
make bin/storm-trident


mkdir -p artifacts/test-image

az login

if uname -a | grep x86_64; then
  tests/images/testimages.py download-image baremetal
fi
if uname -a | grep aarch64; then
  tests/images/testimages.py download-image core_arm64
fi

ISO_NAME=trident-direct-streaming-installer
COSI_NAME=trident-direct-streaming-testimage
if uname -a | grep aarch64; then
  ISO_NAME=trident-direct-streaming-installer-arm64
  COSI_NAME=trident-direct-streaming-testimage-arm64
fi

sudo rm -rf bin/trident-rpms.tar.gz
sudo rm -rf bin/RPMS
make bin/trident-rpms.tar.gz

# Remake ISO image
#export MIC_CONTAINER_IMAGE=imagecustomizer:dev
sudo rm -rf artifacts/$ISO_NAME.iso 
make artifacts/$ISO_NAME.iso

# Remake streaming image
#export MIC_CONTAINER_IMAGE=imagecustomizer:dev
sudo rm -rf artifacts/$COSI_NAME.cosi
make artifacts/$COSI_NAME.cosi
cp artifacts/$COSI_NAME.cosi artifacts/test-image/regular.cosi

./tools/virt-deploy create --mem 12 --disks 32,32

HASH=$(./scripts/cosi-sha384.py ./artifacts/test-image/regular.cosi)
sudo ./bin/storm-trident helper direct-streaming -a -v trace \
    --log-dir /tmp/direct-streaming \
    --netlaunch-config-file ./tools/vm-netlaunch.yaml \
    --cosi-file ./artifacts/test-image/regular.cosi \
    --cosi-metadata-sha384 $HASH \
    --iso-file ./artifacts/$ISO_NAME.iso \
    --port 34761


