image:
  url: http://NETLAUNCH_HOST_ADDRESS/files/regular.cosi
  sha384: ignored
storage:
  disks:
    - id: os
      device: /dev/disk/by-path/pci-0000:00:1f.2-ata-2
      partitionTableType: gpt
      partitions:
        - id: esp
          type: esp
          size: 1G
        - id: root
          type: root
          size: 8G
        - id: web-e-1
          type: linux-generic
          size: 1G
    - id: disk2
      device: /dev/disk/by-path/pci-0000:00:1f.2-ata-3
      partitionTableType: gpt
      partitions:
        - id: web-e-2
          type: linux-generic
          size: 1G
  encryption:
    volumes:
      - id: web
        deviceName: web
        deviceId: web-e
    pcrs:
      # TODO: Once UKI MOS is built and used for all E2E tests, include PCRs 4
      # and 11. Related ADO tasks:
      # https://dev.azure.com/mariner-org/polar/_workitems/edit/14286/
      # and https://dev.azure.com/mariner-org/polar/_workitems/edit/14331.
      #- boot-loader-code # 4
      - secure-boot-policy # 7
      #- kernel-boot # 11
  raid:
    software:
      - id: web-e
        name: web-e
        level: raid1
        devices:
          - web-e-1
          - web-e-2
  filesystems:
    - deviceId: esp
      mountPoint:
        path: /boot/efi
        options: umask=0077
    - deviceId: root
      mountPoint: /
    - deviceId: web
      source: new
      mountPoint: /web
scripts:
  postConfigure:
    - name: testing-privilege
      runOn:
        - clean-install
      content: echo "testing-user ALL=(ALL:ALL) NOPASSWD:ALL" > /etc/sudoers.d/testing-user
    - name: add-selinux-module
      runOn:
        - clean-install
      content: |
        #!/bin/sh
        # Create SELinux policy file
        cat <<EOF > custom-lvm.cil
        ; Allow lvm_t access to semaphores of the initrc_t type
        (allow lvm_t initrc_t (sem (associate unix_read read unix_write write)))
        EOF

        # Apply the SELinux policy
        semodule -i custom-lvm.cil
        echo "Added"
os:
  selinux:
    mode: enforcing
  network:
    version: 2
    ethernets:
      vmeths:
        match:
          name: enp*
        dhcp4: true
  users:
    - name: testing-user
      sshPublicKeys: []
      sshMode: key-only
